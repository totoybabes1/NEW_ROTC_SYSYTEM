{% extends 'personnel/base.html' %}
{% load static %}

{% block title %}My Assigned Students{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="mb-3">
                <i class="fas fa-users me-2"></i>My Assigned Students
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'personnel_dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item active">Assigned Students</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Students</h5>
                    <h2>{{ stats.total_students }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Active Students</h5>
                    <h2>{{ stats.active_students }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-2">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search students...">
                </div>
                <div class="col-md-2 mb-2">
                    <select id="courseFilter" class="form-select">
                        <option value="">All Courses</option>
                        {% for course in stats.by_course %}
                            <option value="{{ course.student__course }}">{{ course.student__course }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-2">
                    <select id="yearFilter" class="form-select">
                        <option value="">All Years</option>
                        {% for year in stats.by_year %}
                            <option value="{{ year.student__year }}">{{ year.student__year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-2">
                    <select id="statusFilter" class="form-select">
                        <option value="">All Status</option>
                        <option value="ACTIVE">Active</option>
                        <option value="INACTIVE">Inactive</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="card shadow-sm">
        <div class="card-body">
            {% if assignments %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Name</th>
                                <th>Course</th>
                                <th>Year Level</th>
                                <th>Gender</th>
                                <th>Status</th>
                                <th>Assigned Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                                <tr>
                                    <td>{{ assignment.student.student_no }}</td>
                                    <td>{{ assignment.student.name }}</td>
                                    <td>{{ assignment.student.course }}</td>
                                    <td>{{ assignment.student.year }}</td>
                                    <td>{{ assignment.student.gender }}</td>
                                    <td>
                                        {% if assignment.student.status == 'ACTIVE' %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ assignment.assigned_date|date:"M d, Y" }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info view-student" 
                                                data-student-id="{{ assignment.student.id }}"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#studentModal">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <a href="{% url 'student_grading' assignment.student.id %}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-graduation-cap"></i>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5>No Students Assigned Yet</h5>
                    <p class="text-muted">You currently don't have any students assigned to you.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Messages -->
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-info alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endif %}

<!-- Student Details Modal -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Student Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="studentDetails"></div>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle view student details
    document.querySelectorAll('.view-student').forEach(button => {
        button.addEventListener('click', function() {
            const studentId = this.dataset.studentId;
            
            fetch(`/personnel/student-details/${studentId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const student = data.student;
                        document.getElementById('modalStudentId').textContent = student.student_no;
                        document.getElementById('modalName').textContent = student.name;
                        document.getElementById('modalCourse').textContent = student.course;
                        document.getElementById('modalYear').textContent = student.year;
                        document.getElementById('modalGender').textContent = student.gender;
                        document.getElementById('modalStatus').textContent = student.status;
                        document.getElementById('modalAssignedDate').textContent = student.assigned_date;
                        
                        // Make sure to properly display time_out in the modal
                        const attendanceInfo = document.getElementById('studentAttendanceInfo');
                        if (data.attendance) {
                            let attendanceHtml = `
                                <p><strong>Today's Status:</strong> <span class="badge ${data.attendance.status_class}">${data.attendance.status}</span></p>
                                <p><strong>Time In:</strong> ${data.attendance.time_in || 'Not recorded'}</p>
                                <p><strong>Time Out:</strong> ${data.attendance.time_out || 'Not recorded'}</p>
                                <p><strong>Remarks:</strong> ${data.attendance.remarks || 'None'}</p>
                            `;
                            attendanceInfo.innerHTML = attendanceHtml;
                        } else {
                            attendanceInfo.innerHTML = '<p>No attendance record for today.</p>';
                        }
                    } else {
                        console.error('Error fetching student details:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    });

    // Handle filters
    function applyFilters() {
        const search = document.getElementById('searchInput').value;
        const course = document.getElementById('courseFilter').value;
        const year = document.getElementById('yearFilter').value;
        const status = document.getElementById('statusFilter').value;

        const params = new URLSearchParams({
            search, course, year, status
        });

        fetch(`/personnel/filter-students/?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateTable(data.students);
                }
            });
    }

    // Add event listeners for filters
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('courseFilter').addEventListener('change', applyFilters);
    document.getElementById('yearFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
});

function updateTable(students) {
    const tbody = document.querySelector('tbody');
    tbody.innerHTML = '';
    
    students.forEach(student => {
        const statusBadge = student.status === 'ACTIVE' 
            ? '<span class="badge bg-success">Active</span>' 
            : '<span class="badge bg-secondary">Inactive</span>';
            
        const row = `
            <tr>
                <td>${student.student_no}</td>
                <td>${student.name}</td>
                <td>${student.course}</td>
                <td>${student.year}</td>
                <td>${student.gender}</td>
                <td>${statusBadge}</td>
                <td>${student.assigned_date}</td>
                <td>
                    <button class="btn btn-sm btn-info view-student" 
                            data-student-id="${student.id}"
                            data-bs-toggle="modal" 
                            data-bs-target="#studentModal">
                        <i class="fas fa-eye"></i>
                    </button>
                    <a href="/personnel/student-grading/${student.id}/" class="btn btn-sm btn-primary">
                        <i class="fas fa-graduation-cap"></i>
                    </a>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
    
    // Reattach event listeners to new buttons
    document.querySelectorAll('.view-student').forEach(button => {
        button.addEventListener('click', function() {
            const studentId = this.dataset.studentId;
            // Fetch and display student details
            // (Same code as above)
        });
    });
}
</script>
{% endblock %}
