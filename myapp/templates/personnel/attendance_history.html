{% extends 'personnel/base.html' %}
{% load static %}

{% block title %}Attendance History{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
<style>
    .filter-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .status-badge {
        min-width: 80px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Filters Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card filter-card">
                <div class="card-body">
                    <form id="filterForm" class="row g-3">
                        <div class="col-md-4">
                            <label for="dateRange" class="form-label">Date Range</label>
                            <input type="text" class="form-control" id="dateRange" name="dateRange">
                        </div>
                        <div class="col-md-3">
                            <label for="studentFilter" class="form-label">Student</label>
                            <select class="form-select" id="studentFilter" name="student_id">
                                <option value="">All Students</option>
                                {% for assignment in assignments %}
                                <option value="{{ assignment.student.id }}">
                                    {{ assignment.student.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">Status</label>
                            <select class="form-select" id="statusFilter" name="status">
                                <option value="">All Statuses</option>
                                <option value="PRESENT">Present</option>
                                <option value="LATE">Late</option>
                                <option value="ABSENT">Absent</option>
                                <option value="EXCUSED">Excused</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-2"></i>Apply Filters
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Records
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.total_records }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Present
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.present_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Late
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.late_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Absent
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ stats.absent_count }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Records Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Attendance Records</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="attendanceTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Student</th>
                                    <th>Date</th>
                                    <th>Time In</th>
                                    <th>Time Out</th>
                                    <th>Status</th>
                                    <th>Remarks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in attendance_records %}
                                <tr>
                                    <td>{{ record.id }}</td>
                                    <td>{{ record.student.name }}</td>
                                    <td>{{ record.date|date:"M d, Y" }}</td>
                                    <td>{{ record.time_in|default:"-" }}</td>
                                    <td>{{ record.time_out|default:"-" }}</td>
                                    <td>
                                        <span class="badge {% if record.status == 'PRESENT' %}bg-success{% elif record.status == 'ABSENT' %}bg-danger{% elif record.status == 'LATE' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ record.status }}
                                        </span>
                                    </td>
                                    <td>{{ record.remarks|default:"-" }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary edit-attendance" 
                                                data-id="{{ record.id }}"
                                                data-student-id="{{ record.student.id }}"
                                                data-student-name="{{ record.student.name }}"
                                                data-date="{{ record.date|date:'Y-m-d' }}"
                                                data-time-in="{{ record.time_in|time:'H:i'|default:'' }}"
                                                data-time-out="{{ record.time_out|time:'H:i'|default:'' }}"
                                                data-status="{{ record.status }}"
                                                data-remarks="{{ record.remarks|default:'' }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">No attendance records found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Attendance Modal -->
    <div class="modal fade" id="editAttendanceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Attendance Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editAttendanceForm">
                        {% csrf_token %}
                        <input type="hidden" id="edit_record_id" name="record_id">
                        <div class="mb-3">
                            <label class="form-label">Student</label>
                            <input type="text" class="form-control" id="edit_student_name" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="edit_date" name="date" readonly>
                        </div>
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">Time In</label>
                                <input type="time" class="form-control" id="edit_time_in" name="time_in">
                            </div>
                            <div class="col">
                                <label class="form-label">Time Out</label>
                                <input type="time" class="form-control" id="edit_time_out" name="time_out">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="edit_status" name="status">
                                <option value="PRESENT">Present</option>
                                <option value="ABSENT">Absent</option>
                                <option value="LATE">Late</option>
                                <option value="EXCUSED">Excused</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Remarks</label>
                            <textarea class="form-control" id="edit_remarks" name="remarks" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveAttendanceChanges">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script>
$(document).ready(function() {
    // Add this line to ensure CSRF token is included in all AJAX requests
    $.ajaxSetup({
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    });

    // Initialize DataTable with row selection
    var table = $('#attendanceTable').DataTable({
        responsive: true,
        language: {
            search: "_INPUT_",
            searchPlaceholder: "Search records..."
        },
        // These settings will fix the DataTables error
        columnDefs: [
            { targets: '_all', defaultContent: '' }
        ],
        // Disable sorting on the actions column
        "columnDefs": [
            { "orderable": false, "targets": 6 }
        ],
        // Make sure DataTables doesn't try to process empty tables
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
        "order": [[ 1, 'desc' ]],
        // Add row selection functionality
        'columnDefs': [{
            'targets': 0,
            'checkboxes': {
                'selectRow': true
            },
            'render': function (data, type, full, meta) {
                return '<input type="checkbox" class="dt-checkboxes">';
            }
        }],
        'select': {
            'style': 'multi'
        },
        // Add error handling
        "initComplete": function(settings, json) {
            console.log("DataTable initialized successfully");
        },
        "drawCallback": function(settings) {
            // Reattach event handlers after table redraw
            $('.edit-attendance').on('click', function() {
                const id = $(this).data('id');
                const studentName = $(this).data('student-name');
                const date = $(this).data('date');
                const timeIn = $(this).data('time-in');
                const timeOut = $(this).data('time-out');
                const status = $(this).data('status');
                const remarks = $(this).data('remarks');
                
                // Populate modal
                $('#edit_record_id').val(id);
                $('#edit_student_name').val(studentName);
                $('#edit_date').val(date);
                $('#edit_time_in').val(timeIn);
                $('#edit_time_out').val(timeOut);
                $('#edit_status').val(status);
                $('#edit_remarks').val(remarks);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('editAttendanceModal'));
                modal.show();
            });
        },
        "columns": [
            { "data": "id" },
            { "data": "student_name" },
            { "data": "date" },
            { "data": "time_in" },
            { "data": "time_out" },
            { "data": "status" },
            { "data": "remarks" },
            { "data": "actions" }
        ]
    });

    // Initialize DateRangePicker
    $('#dateRange').daterangepicker({
        opens: 'left',
        maxDate: new Date(),
        ranges: {
           'Today': [moment(), moment()],
           'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
           'Last 7 Days': [moment().subtract(6, 'days'), moment()],
           'Last 30 Days': [moment().subtract(29, 'days'), moment()],
           'This Month': [moment().startOf('month'), moment().endOf('month')],
           'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    });

    // Handle filter form submission
    $('#filterForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const params = new URLSearchParams(formData);
        
        window.location.href = `{% url 'view_attendance_history' %}?${params.toString()}`;
    });

    // Save attendance changes
    $('#saveAttendanceChanges').on('click', function() {
        const formData = new FormData(document.getElementById('editAttendanceForm'));
        
        $.ajax({
            url: '{% url "update_attendance" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('editAttendanceModal')).hide();
                    
                    // Show success message
                    const alertHtml = `
                        <div class="alert alert-success alert-dismissible fade show">
                            ${response.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    $('.container-fluid').prepend(alertHtml);
                    
                    // Reload page after a short delay
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    alert(response.message);
                }
            },
            error: function() {
                alert('An error occurred while updating the attendance record.');
            }
        });
    });

    // Handle batch update
    $('#batchUpdateAttendance').on('click', function() {
        var selectedRows = table.rows('.selected').data();
        
        if (selectedRows.length === 0) {
            alert('Please select at least one record to update');
            return;
        }
        
        const date = $('#batchDate').val();
        const status = $('#batchStatus').val();
        const timeIn = $('#batchTimeIn').val();
        const timeOut = $('#batchTimeOut').val();
        
        if (!status && !timeIn && !timeOut) {
            alert('Please specify at least one field to update');
            return;
        }
        
        // Confirm before proceeding
        if (!confirm(`Are you sure you want to update ${selectedRows.length} attendance records?`)) {
            return;
        }
        
        // Prepare data for batch update
        const recordIds = [];
        for (let i = 0; i < selectedRows.length; i++) {
            recordIds.push(selectedRows[i][0]); // Assuming ID is in the first column
        }
        
        // Show loading indicator
        const updateBtn = $('#batchUpdateAttendance');
        const originalText = updateBtn.html();
        updateBtn.html('<i class="fas fa-spinner fa-spin"></i> Updating...');
        updateBtn.prop('disabled', true);
        
        // Send batch update request
        $.ajax({
            url: '{% url "batch_update_attendance" %}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                record_ids: recordIds,
                date: date || null,
                status: status || null,
                time_in: timeIn || null,
                time_out: timeOut || null
            }),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    // Reload the page to show updated records
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('An error occurred while updating attendance records.');
            },
            complete: function() {
                // Restore button state
                updateBtn.html(originalText);
                updateBtn.prop('disabled', false);
            }
        });
    });
});
</script>
{% endblock %} 