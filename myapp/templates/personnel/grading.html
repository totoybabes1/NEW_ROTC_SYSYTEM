{% extends 'personnel/base.html' %}
{% load static %}

{% block title %}Student Grading{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<style>
    .grading-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .table-bordered th, .table-bordered td {
        border: 1px solid #dee2e6;
    }
    .computation-section {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .military-table {
        font-size: 0.85rem;
    }
    .form-label {
        font-weight: 600;
    }
    .readonly-field {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="mb-3">
                <i class="fas fa-graduation-cap me-2"></i>Student Grading
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'personnel_dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'view_assigned_students' %}">Assigned Students</a></li>
                    <li class="breadcrumb-item active">Grading</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Student Info -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card grading-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Student Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Student ID</label>
                            <input type="text" class="form-control readonly-field" value="{{ student.student_no }}" readonly>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control readonly-field" value="{{ student.name }}" readonly>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Course</label>
                            <input type="text" class="form-control readonly-field" value="{{ student.course }}" readonly>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Year</label>
                            <input type="text" class="form-control readonly-field" value="{{ student.year }}" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Tracking -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card grading-card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Activity Tracking</h5>
                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addActivityModal">
                        <i class="fas fa-plus"></i> Add Activity
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="activityTable">
                            <thead class="bg-light">
                                <tr>
                                    <th style="width: 50px;">SF</th>
                                    <th style="width: 120px;">DATE</th>
                                    <th style="width: 100px;">CDT SIGN</th>
                                    <th>ACTIVITY</th>
                                    <th style="width: 100px;">MERITS</th>
                                    <th style="width: 100px;">DEMERITS</th>
                                    <th style="width: 100px;">FL SIGN</th>
                                    <th style="width: 150px;">REMARKS</th>
                                    <th style="width: 80px;">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in activities %}
                                <tr>
                                    <td>{{ activity.sf }}</td>
                                    <td>{{ activity.date|date:"m/d/Y" }}</td>
                                    <td>{{ activity.cadet_sign }}</td>
                                    <td>{{ activity.activity_description }}</td>
                                    <td>{{ activity.merits }}</td>
                                    <td>{{ activity.demerits }}</td>
                                    <td>{{ activity.flight_leader_sign }}</td>
                                    <td>{{ activity.remarks }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info edit-activity" data-activity-id="{{ activity.id }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-activity" data-activity-id="{{ activity.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="text-center">No activities recorded yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Grade Computation -->
    <div class="row">
        <div class="col-md-8">
            <div class="card grading-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Computation of Grade</h5>
                </div>
                <div class="card-body">
                    <form id="gradeForm" method="POST" action="{% url 'update_student_grade' student.id %}">
                        {% csrf_token %}
                        
                        <!-- Attendance Section -->
                        <div class="computation-section">
                            <h6 class="fw-bold mb-3">ATTENDANCE (30%)</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="num_periods" class="form-label">Total Class Periods</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="num_periods" name="num_periods" value="{{ grade.num_periods|default:0 }}" readonly>
                                        <button type="button" class="btn btn-outline-primary" id="fetchAttendanceData">
                                            <i class="fas fa-sync-alt"></i> Fetch from Attendance
                                        </button>
                                    </div>
                                    <small class="text-muted">This will be calculated from attendance records</small>
                                </div>
                                <div class="col-md-6">
                                    <label for="attendance_score" class="form-label">Attendance Score (30%)</label>
                                    <input type="number" class="form-control" id="attendance_score" name="attendance_score" value="{{ grade.attendance_score|default:0 }}" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aptitude Section -->
                        <div class="computation-section">
                            <h6 class="fw-bold mb-3">APTITUDE</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Number of TWs</label>
                                    <input type="number" class="form-control" id="num_tws" name="num_tws" 
                                           value="{{ grade.num_tws|default:0 }}" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Military Aptitude Section -->
                        <div class="computation-section">
                            <h6 class="fw-bold mb-3">MILITARY APTITUDE (30%)</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Number of Merits</label>
                                    <input type="number" class="form-control" id="num_merits" name="num_merits" 
                                           value="{{ grade.num_merits|default:0 }}" min="0">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Number of Demerits</label>
                                    <input type="number" class="form-control" id="num_demerits" name="num_demerits" 
                                           value="{{ grade.num_demerits|default:0 }}" min="0">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="form-label">Military Aptitude Formula</label>
                                    <div class="input-group">
                                        <span class="input-group-text">100 MERITS - NR OF DEMERITS X 30% =</span>
                                        <input type="number" class="form-control readonly-field" id="military_score" 
                                               name="military_score" value="{{ grade.military_score|default:0 }}" readonly>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Subject Proficiency Section -->
                        <div class="computation-section">
                            <h6 class="fw-bold mb-3">SUBJECT PROFICIENCY (40%)</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Score</label>
                                    <input type="number" class="form-control" id="subject_score" name="subject_score" 
                                           value="{{ grade.subject_score|default:0 }}" min="0" max="100">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Subject Proficiency Formula</label>
                                    <div class="input-group">
                                        <span class="input-group-text">SCORE X 40% X 100 =</span>
                                        <input type="number" class="form-control readonly-field" id="proficiency_score" 
                                               name="proficiency_score" value="{{ grade.proficiency_score|default:0 }}" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label class="form-label">Number of Items</label>
                                    <input type="number" class="form-control" id="num_items" name="num_items" 
                                           value="{{ grade.num_items|default:0 }}" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Total Grade -->
                        <div class="computation-section">
                            <h6 class="fw-bold mb-3">TOTAL NUMERICAL GRADE</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <input type="number" class="form-control form-control-lg readonly-field" 
                                           id="total_grade" name="total_grade" value="{{ grade.total_grade|default:0 }}" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" id="calculateGrade" class="btn btn-secondary me-md-2">
                                <i class="fas fa-calculator me-2"></i>Calculate
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Grade
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card grading-card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Equivalent Aptitude in Relation to Absences</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm military-table">
                            <thead class="bg-light">
                                <tr>
                                    <th class="text-center">ABSENCES</th>
                                    <th class="text-center">MILITARY</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td class="text-center">0</td><td class="text-center">100</td></tr>
                                <tr><td class="text-center">1</td><td class="text-center">97</td></tr>
                                <tr><td class="text-center">2</td><td class="text-center">94</td></tr>
                                <tr><td class="text-center">3</td><td class="text-center">91</td></tr>
                                <tr><td class="text-center">4</td><td class="text-center">88</td></tr>
                                <tr><td class="text-center">5</td><td class="text-center">85</td></tr>
                                <tr><td class="text-center">6</td><td class="text-center">82</td></tr>
                                <tr><td class="text-center">7</td><td class="text-center">79</td></tr>
                                <tr><td class="text-center">8</td><td class="text-center">76</td></tr>
                                <tr><td class="text-center">9</td><td class="text-center">73</td></tr>
                                <tr><td class="text-center">10</td><td class="text-center">70</td></tr>
                                <tr><td class="text-center">11</td><td class="text-center">67</td></tr>
                                <tr><td class="text-center">12</td><td class="text-center">64</td></tr>
                                <tr><td class="text-center">13</td><td class="text-center">61</td></tr>
                                <tr><td class="text-center">14</td><td class="text-center">58</td></tr>
                                <tr><td class="text-center">15</td><td class="text-center">55</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Activity Modal -->
<div class="modal fade" id="addActivityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Add Activity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="activityForm" method="POST" action="{% url 'add_student_activity' student.id %}">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">SF Number</label>
                            <input type="number" class="form-control" name="sf" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" name="date" value="{{ today|date:'Y-m-d' }}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cadet Sign</label>
                            <input type="text" class="form-control" name="cadet_sign">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Activity Description</label>
                            <textarea class="form-control" name="activity_description" rows="2" required></textarea>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Merits</label>
                            <input type="number" class="form-control" name="merits" value="0" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Demerits</label>
                            <input type="number" class="form-control" name="demerits" value="0" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Flight Leader Sign</label>
                            <input type="text" class="form-control" name="flight_leader_sign">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Remarks</label>
                            <textarea class="form-control" name="remarks" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="button" class="btn btn-secondary me-md-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Activity</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Activity Modal -->
<div class="modal fade" id="editActivityModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Activity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editActivityForm" method="POST">
                    {% csrf_token %}
                    <input type="hidden" id="edit_activity_id" name="activity_id">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">SF Number</label>
                            <input type="number" class="form-control" id="edit_sf" name="sf" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="edit_date" name="date" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cadet Sign</label>
                            <input type="text" class="form-control" id="edit_cadet_sign" name="cadet_sign">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Activity Description</label>
                            <textarea class="form-control" id="edit_activity_description" name="activity_description" rows="2" required></textarea>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Merits</label>
                            <input type="number" class="form-control" id="edit_merits" name="merits" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Demerits</label>
                            <input type="number" class="form-control" id="edit_demerits" name="demerits" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Flight Leader Sign</label>
                            <input type="text" class="form-control" id="edit_flight_leader_sign" name="flight_leader_sign">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Remarks</label>
                            <textarea class="form-control" id="edit_remarks" name="remarks" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="button" class="btn btn-secondary me-md-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Activity</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Add DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable
    if ($.fn.DataTable) {
        $('#activityTable').DataTable({
            responsive: true,
            order: [[1, 'desc']], // Sort by date descending
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search activities..."
            }
        });
    } else {
        console.error("DataTables library not loaded properly");
    }
    
    // Calculate grade when button is clicked
    $('#calculateGrade').on('click', function() {
        calculateGrade();
    });
    
    // Auto-calculate when inputs change
    $('#num_periods, #num_merits, #num_demerits, #subject_score').on('change', function() {
        calculateGrade();
    });
    
    // Fetch attendance data when button is clicked
    $('#fetchAttendanceData').on('click', function() {
        const studentId = {{ student.id }};
        const btn = $(this);
        const originalText = btn.html();
        
        btn.html('<i class="fas fa-spinner fa-spin"></i> Loading...');
        btn.prop('disabled', true);
        
        // Fetch attendance data from the server
        $.ajax({
            url: `/personnel/student-attendance-summary/${studentId}/`,
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    // Update the form with attendance data
                    $('#num_periods').val(response.total_periods);
                    
                    // Calculate attendance score (30% of grade)
                    const attendancePercentage = response.present_count / response.total_periods * 100;
                    const attendanceScore = (attendancePercentage / 100) * 30;
                    $('#attendance_score').val(attendanceScore.toFixed(2));
                    
                    // Recalculate total grade
                    calculateGrade();
                    
                    // Show success message
                    alert(`Attendance data loaded: ${response.present_count} present out of ${response.total_periods} total periods.`);
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('An error occurred while fetching attendance data.');
            },
            complete: function() {
                btn.html(originalText);
                btn.prop('disabled', false);
            }
        });
    });
    
    // Modify the calculateGrade function to use the attendance score
    function calculateGrade() {
        // Get values from form
        const attendanceScore = parseFloat($('#attendance_score').val()) || 0;
        const numMerits = parseInt($('#num_merits').val()) || 0;
        const numDemerits = parseInt($('#num_demerits').val()) || 0;
        const subjectScore = parseFloat($('#subject_score').val()) || 0;
        
        // Calculate military score (30% of grade)
        const militaryScore = calculateMilitaryScore(numMerits, numDemerits);
        $('#military_score').val(militaryScore.toFixed(2));
        
        // Calculate proficiency score (40% of grade)
        const proficiencyScore = subjectScore * 0.4;
        $('#proficiency_score').val(proficiencyScore.toFixed(2));
        
        // Calculate total grade
        const totalGrade = attendanceScore + militaryScore + proficiencyScore;
        $('#total_grade').val(totalGrade.toFixed(2));
        
        // Update the grade display
        updateGradeDisplay(totalGrade);
    }
    
    // Handle edit activity button clicks
    $(document).on('click', '.edit-activity', function() {
        const activityId = $(this).data('activity-id');
        
        // Fetch activity data
        $.ajax({
            url: `/personnel/get-activity/${activityId}/`,
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    const activity = response.activity;
                    
                    // Populate the edit form
                    $('#edit_activity_id').val(activity.id);
                    $('#edit_sf').val(activity.sf);
                    $('#edit_date').val(activity.date);
                    $('#edit_cadet_sign').val(activity.cadet_sign);
                    $('#edit_activity_description').val(activity.activity_description);
                    $('#edit_merits').val(activity.merits);
                    $('#edit_demerits').val(activity.demerits);
                    $('#edit_flight_leader_sign').val(activity.flight_leader_sign);
                    $('#edit_remarks').val(activity.remarks);
                    
                    // Set the form action
                    $('#editActivityForm').attr('action', `/personnel/edit-activity/${activity.id}/`);
                    
                    // Show the modal
                    $('#editActivityModal').modal('show');
                } else {
                    alert('Error: ' + response.message);
                }
            },
            error: function() {
                alert('An error occurred while fetching activity data.');
            }
        });
    });
    
    // Handle delete activity button clicks
    $(document).on('click', '.delete-activity', function() {
        if (confirm('Are you sure you want to delete this activity?')) {
            const activityId = $(this).data('activity-id');
            
            $.ajax({
                url: `/personnel/delete-activity/${activityId}/`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        // Reload the page to show updated data
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function() {
                    alert('An error occurred while deleting the activity.');
                }
            });
        }
    });
    
    // Calculate grade on page load
    calculateGrade();
});
</script>
{% endblock %} 