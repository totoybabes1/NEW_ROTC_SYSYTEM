{% extends 'admin/base.html' %}
{% load static %}
{% load event_tags %}

{% block title %}Event Calendar{% endblock %}

{% block content %}

<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<div class="container-fluid" data-aos="fade-in">
    
    <div class="row mb-4" data-aos="fade-up">
       
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-5">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="bg-primary bg-opacity-25 rounded-circle p-4">
                                    <i class="fa-solid fa-users text-primary fa-3x fw-bold"></i>
                                </div>
                            </div>
                            <div class="col">
                                <h1 class="display-4 mb-0 fw-bolder">Event Calendar</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border">
                <div class="card-body p-4">
                    <div class="accordion" id="eventAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOne">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                    <h3 class="mb-0">Event Calendar</h3>
                                </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#eventAccordion">
                                <div class="accordion-body">
                                    <p class="text-muted mb-4">
                                        Create and manage events for your flight groups. Schedule training sessions, meetings, and other activities with ease.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <br>
                    <button class="btn btn-primary position-relative py-2" data-bs-toggle="modal" data-bs-target="#addEventModal">
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-white bg-opacity-25 p-1 me-2">
                                <i class="fas fa-plus-circle text-white"></i>
                            </div>
                            <div class="text-start">
                                <small class="d-block text-white-50">Add</small>
                                <span class="fw-bold">Add Event</span>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
     <!-- Messages -->
     {% if messages %}
     {% for message in messages %}
         <div class="alert alert-info alert-dismissible fade show">
             {{ message }}
             <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
         </div>
     {% endfor %}
 {% endif %}
    

    <div class="row">
        <!-- LEFT SIDE: Event Cards Column -->
        <div class="col-md-5" data-aos="fade-up" data-aos-delay="100">
            <!-- Nav Tabs -->
            <div class="card shadow-sm">
                <!-- Enhanced Tab Navigation -->
                <div class="card-header bg-white p-0 border-bottom">
                    <ul class="nav nav-tabs nav-fill border-0" id="eventTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active py-3 px-4" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming-events" type="button" role="tab">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                        <i class="fas fa-calendar-alt text-primary fa-lg"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fs-4">Upcoming Events</h6>
                                        <small class="text-muted fs-6">View upcoming events</small>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link py-3 px-4" id="flight-groups-tab" data-bs-toggle="tab" data-bs-target="#flight-groups-events" type="button" role="tab">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                        <i class="fas fa-layer-group text-primary fa-lg"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fs-4">Events by Flight Group</h6>
                                        <small class="text-muted fs-6">Group-specific events</small>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link py-3 px-4" id="history-tab" data-bs-toggle="tab" data-bs-target="#event-history" type="button" role="tab">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                        <i class="fas fa-history text-primary fa-lg"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fs-4">Event History</h6>
                                        <small class="text-muted fs-6">Past events archive</small>
                                    </div>
                                </div>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Tab Content -->
            <div class="tab-content" id="eventTabsContent">
                <!-- Upcoming Events Tab -->
                <div class="tab-pane fade show active" id="upcoming-events" role="tabpanel" aria-labelledby="upcoming-tab">
                    <div class="card border rounded-lg mb-4">
                        <div class="card-header bg-white border-bottom pt-4 pb-2">
                            <h5 class="mb-0 text-primary"><i class="fas fa-calendar-alt me-2"></i> Upcoming Events</h5>
                        </div>
                        <div class="card-body">
                            <div class="upcoming-events">
                                {% if events %}
                                    {% for event in events %}
                                        <div class="event-card mb-3 border rounded p-3">
                                          
                                            <div class="event-content">
                                                <h5 class="event-title">{{ event.title }}</h5>
                                                <p class="event-group">
                                                    {% with event_obj=event.id|get_event_object %}
                                                        {% if event_obj %}
                                                            {% with event_groups=event_obj.event_flight_groups.all %}
                                                                {% if event_groups.exists %}
                                                                    {% for eg in event_groups %}
                                                                        <span class="badge bg-primary me-1">{{ eg.flight_group.name }}</span>
                                                                    {% endfor %}
                                                                {% elif event_obj.flight_group %}
                                                                    <span class="badge bg-primary">{{ event_obj.flight_group.name }}</span>
                                                                {% endif %}
                                                            {% endwith %}
                                                        {% else %}
                                                            {{ event.flight_group }}
                                                        {% endif %}
                                                    {% endwith %}
                                                </p>
                                                <p class="event-desc">{{ event.content|truncatechars:100 }}</p>
                                                <div class="event-actions">
                                                    <button class="btn btn-sm btn-outline-primary edit-event-btn" 
                                                            data-event-id="{{ event.id }}">
                                                        <i class="fas fa-edit"></i> Edit
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger delete-event-btn" 
                                                            data-event-id="{{ event.id }}"
                                                            data-event-title="{{ event.title }}">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-center text-muted py-4">
                                        <i class="fas fa-calendar-times fa-3x mb-3"></i>
                                        <p>No events scheduled for this month</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Events by Flight Group Tab -->
                <div class="tab-pane fade" id="flight-groups-events" role="tabpanel" aria-labelledby="flight-groups-tab">
                    <div class="card border mb-4">
                        <div class="card-header bg-white border-bottom">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-layer-group me-2 text-primary"></i> Events by Flight Group
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="accordion" id="flightGroupAccordion">
                                {% for group in flight_groups %}
                                    <div class="accordion-item border">
                                        <h2 class="accordion-header" id="heading{{ group.id }}">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                    data-bs-target="#collapse{{ group.id }}" aria-expanded="false" 
                                                    aria-controls="collapse{{ group.id }}">
                                                {{ group.name }} 
                                                <span class="badge bg-primary rounded-pill ms-2">
                                                    {{ events_by_group|get_item:group.id|length }}
                                                </span>
                                            </button>
                                        </h2>
                                        <div id="collapse{{ group.id }}" class="accordion-collapse collapse" 
                                             aria-labelledby="heading{{ group.id }}" data-bs-parent="#flightGroupAccordion">
                                            <div class="accordion-body p-0">
                                                <div class="list-group list-group-flush">
                                                    {% with group_events=events_by_group|get_item:group.id %}
                                                        {% if group_events %}
                                                            {% for event in group_events %}
                                                                <a href="#" class="list-group-item list-group-item-action border-top border-bottom" 
                                                                   onclick="openEditEventModal({{ event.id }}); return false;">
                                                                    <div class="d-flex w-100 justify-content-between">
                                                                        <h6 class="mb-1">{{ event.title }}</h6>
                                                                        <small>{{ event.event_date|date:"Y-m-d" }}</small>
                                                                    </div>
                                                                    <small>{{ event.content|truncatechars:50 }}</small>
                                                                </a>
                                                            {% endfor %}
                                                        {% else %}
                                                            <div class="list-group-item text-center text-muted">
                                                                <i class="fas fa-calendar-times me-2"></i> No events for this group
                                                            </div>
                                                        {% endif %}
                                                    {% endwith %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Event History Tab -->
                <div class="tab-pane fade" id="event-history" role="tabpanel" aria-labelledby="history-tab">
                    <div class="card border rounded-lg mb-4">
                        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center pt-4 pb-2">
                            <h5 class="mb-0 text-primary"><i class="fas fa-history me-2"></i> Event History</h5>
                            <div>
                                <button class="btn btn-light btn-sm border me-2" id="exportEvents">
                                    <i class="fas fa-file-export"></i> Export
                                </button>
                                <div class="dropdown d-inline-block">
                                    <button class="btn btn-light btn-sm border dropdown-toggle" type="button" id="exportFormatDropdown" data-bs-toggle="dropdown">
                                        Format
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" data-format="csv">CSV</a></li>
                                        <li><a class="dropdown-item" href="#" data-format="excel">Excel</a></li>
                                        <li><a class="dropdown-item" href="#" data-format="pdf">PDF</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-12 mb-2">
                                    <input type="text" class="form-control border" id="eventSearch" placeholder="Search events...">
                                </div>
                                <div class="col-md-6 mb-2">
                                    <select class="form-select border" id="historyFlightGroupFilter">
                                        <option value="all">All Flight Groups</option>
                                        {% for group in flight_groups %}
                                            <option value="{{ group.id }}">{{ group.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <input type="month" class="form-control border" id="eventDateFilter">
                                </div>
                                <div class="col-md-12">
                                    <button class="btn btn-primary btn-sm w-100" id="clearFilters">
                                        Clear Filters
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover border" id="eventHistoryTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Title</th>
                                            <th>Flight Group</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for event in all_events %}
                                        <tr>
                                            <td>{{ event.event_date|date:"Y-m-d" }}</td>
                                            <td>{{ event.title }}</td>
                                            <td>
                                                {% with event_obj=event.id|get_event_object %}
                                                    {% if event_obj %}
                                                        {% with event_groups=event_obj.event_flight_groups.all %}
                                                            {% if event_groups.exists %}
                                                                {% for eg in event_groups %}
                                                                    <span class="badge bg-primary me-1">{{ eg.flight_group.name }}</span>
                                                                {% endfor %}
                                                            {% elif event_obj.flight_group %}
                                                                <span class="badge bg-primary">{{ event_obj.flight_group.name }}</span>
                                                            {% endif %}
                                                        {% endwith %}
                                                    {% else %}
                                                        {{ event.flight_group.name }}
                                                    {% endif %}
                                                {% endwith %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary edit-event-btn" 
                                                        data-event-id="{{ event.id }}">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger delete-event-btn" 
                                                        data-event-id="{{ event.id }}"
                                                        data-event-title="{{ event.title }}">
                                                    <i class="fas fa-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- RIGHT SIDE: Calendar Column -->
        <div class="col-md-7" data-aos="fade-up" data-aos-delay="200">
            <div class="card border rounded-lg">
                <div class="card-body p-4">
                    <!-- Calendar Navigation -->
                    <div class="calendar-navigation mb-4 d-flex justify-content-between align-items-center">
                        <a href="?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-light border rounded-pill">
                            <i class="fas fa-chevron-left me-1"></i> Previous
                        </a>
                        <h2 class="month-title">{{ month_name }} {{ year }}</h2>
                        <a href="?year={{ next_year }}&month={{ next_month }}" class="btn btn-light border rounded-pill">
                            Next <i class="fas fa-chevron-right ms-1"></i>
                        </a>
                    </div>
                    
                    <!-- Calendar -->
                    <div class="calendar-container border rounded">
                        <div class="calendar-header rounded-top">
                            <div class="calendar-day">Sun</div>
                            <div class="calendar-day">Mon</div>
                            <div class="calendar-day">Tue</div>
                            <div class="calendar-day">Wed</div>
                            <div class="calendar-day">Thu</div>
                            <div class="calendar-day">Fri</div>
                            <div class="calendar-day">Sat</div>
                        </div>
                        <div class="calendar-body">
                            {% for week in calendar %}
                                <div class="calendar-week">
                                    {% for date in week %}
                                        {% if date.empty %}
                                            <div class="calendar-date empty"></div>
                                        {% else %}
                                            <div class="calendar-date{% if date.weekday == 0 %} sunday{% endif %}" 
                                                 data-date="{{ date.date }}" data-bs-toggle="popover" data-bs-trigger="hover focus" 
                                                 data-bs-placement="top" data-bs-html="true" data-bs-title="Events on {{ date.date }}">
                                                <div class="date-number">{{ date.day }}</div>
                                                <div class="event-count">0</div>
                                                <div class="event-indicator-container d-flex flex-wrap mt-1"></div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Event Details Panel -->
                    <div class="event-details-panel mt-3 border rounded p-3 d-none">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="selected-date mb-0"></h5>
                            <button type="button" class="btn-close" aria-label="Close" id="closeEventDetails"></button>
                        </div>
                        <div class="event-details-content">
                            <!-- Event details will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Recurring Event Modal -->
    <div class="modal fade" id="recurringEventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Recurring Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="recurringEventForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label>Title</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>
                        <div class="mb-3">
                            <label>Content</label>
                            <textarea class="form-control" name="content" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label>Start Date</label>
                                    <input type="date" class="form-control" name="start_date" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label>End Date</label>
                                    <input type="date" class="form-control" name="end_date" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>Frequency</label>
                            <select class="form-select" name="frequency" required>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label>Flight Groups</label>
                            <select class="form-select select2-multiple" name="flight_groups[]" multiple required>
                                {% for group in flight_groups %}
                                    <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Events</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Attendance Tracking Modal -->
    <div class="modal fade" id="attendanceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Track Attendance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table" id="attendanceTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>Excused</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveAttendance">Save Attendance</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i> Add New Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'add_event' %}" method="POST" id="addEventForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="eventTitle" class="form-label">Event Title</label>
                        <input type="text" class="form-control border" id="eventTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="eventDate" class="form-label">Event Date</label>
                        <input type="date" class="form-control border" id="eventDate" name="event_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="flightGroups" class="form-label">Flight Groups</label>
                        <select class="form-select border select2-multiple" id="flightGroups" name="flight_groups[]" multiple required>
                            {% for group in flight_groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <div id="selectedGroupsDisplay" class="mt-2 d-none">
                            <p class="mb-1 fw-bold">Selected Groups:</p>
                            <div class="selected-groups-badges"></div>
                        </div>
                        <div class="form-text text-muted">Select multiple groups for this event</div>
                    </div>
                    <div class="mb-3">
                        <label for="eventContent" class="form-label">Event Description</label>
                        <textarea class="form-control border" id="eventContent" name="content" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="addEventSubmitBtn">Add Event</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i> Edit Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editEventForm" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editEventTitle" class="form-label">Event Title</label>
                        <input type="text" class="form-control border" id="editEventTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEventDate" class="form-label">Event Date</label>
                        <input type="date" class="form-control border" id="editEventDate" name="event_date" required>
                    </div>
                    <div class="mb-3">
                        <label for="editFlightGroups" class="form-label">Flight Groups</label>
                        <select class="form-select border select2-multiple" id="editFlightGroups" name="flight_groups[]" multiple required>
                            {% for group in flight_groups %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                        <div id="editSelectedGroupsDisplay" class="mt-2 d-none">
                            <p class="mb-1 fw-bold">Selected Groups:</p>
                            <div class="selected-groups-badges"></div>
                        </div>
                        <div class="form-text text-muted">Select multiple groups for this event</div>
                    </div>
                    <div class="mb-3">
                        <label for="editEventContent" class="form-label">Event Description</label>
                        <textarea class="form-control border" id="editEventContent" name="content" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="editEventSubmitBtn">Update Event</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Event Modal -->
<div class="modal fade" id="deleteEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i> Delete Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the event: <strong id="deleteEventTitle"></strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="#" id="confirmDeleteBtn" class="btn btn-danger">Delete Event</a>
            </div>
        </div>
    </div>
</div>

<!-- Initialize AOS -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
    AOS.init({
        duration: 800,
        easing: 'ease-in-out',
        once: true
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Select2 for better multi-select experience
        if (typeof $.fn.select2 !== 'undefined') {
            $('.select2-multiple').select2({
                placeholder: "Select flight groups",
                allowClear: true,
                width: '100%'
            });
        }
        
        // Store events data from backend
        let eventsData = [];
        try {
            eventsData = {{ events_json|safe }};
        } catch (error) {
            console.error('Error parsing events data:', error);
            eventsData = [];
        }
        
        // Populate calendar with event counts and indicators
        populateCalendarWithEvents(eventsData);
        
        // Initialize popovers with dynamic content
        const calendarDates = document.querySelectorAll('.calendar-date:not(.empty)');
        calendarDates.forEach(dateCell => {
            const dateStr = dateCell.getAttribute('data-date');
            if (!dateStr) return;
            
            // Prepare popover content
            const dateEvents = eventsData.filter(event => event.date === dateStr);
            let popoverContent = '';
            
            if (dateEvents.length === 0) {
                popoverContent = '<div class="text-muted">No events scheduled</div>';
            } else {
                popoverContent = '<div class="popover-event-list">';
                dateEvents.forEach(event => {
                    popoverContent += `
                        <div class="popover-event mb-1">
                            <div class="fw-bold">${event.title}</div>
                            <div class="small text-truncate" style="max-width: 200px;">${event.content || ''}</div>
                        </div>
                    `;
                });
                popoverContent += '</div>';
            }
            
            // Set the content directly
            dateCell.setAttribute('data-bs-content', popoverContent);
            
            // Handle click event
            dateCell.addEventListener('click', function(e) {
                e.preventDefault();
                showEventDetailsPanel(dateStr, eventsData);
            });
        });
        
        // Initialize Bootstrap popovers after setting content
        const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
        [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl, {
            container: 'body',
            html: true
        }));
        
        // Close event details panel
        const closeEventDetailsBtn = document.getElementById('closeEventDetails');
        if (closeEventDetailsBtn) {
            closeEventDetailsBtn.addEventListener('click', function() {
                const eventDetailsPanel = document.querySelector('.event-details-panel');
                if (eventDetailsPanel) {
                    eventDetailsPanel.classList.add('d-none');
                }
            });
        }
        
        // Mark today's date
        markTodayDate();
        
        // Handle flight group selection display for Add Event
        const flightGroupsSelect = document.getElementById('flightGroups');
        const selectedGroupsDisplay = document.getElementById('selectedGroupsDisplay');
        const selectedGroupsBadges = selectedGroupsDisplay ? selectedGroupsDisplay.querySelector('.selected-groups-badges') : null;
        
        if (flightGroupsSelect && selectedGroupsDisplay && selectedGroupsBadges) {
            flightGroupsSelect.addEventListener('change', function() {
                updateSelectedGroupsDisplay(this, selectedGroupsDisplay, selectedGroupsBadges);
            });
        }
        
        // Handle flight group selection display for Edit Event
        const editFlightGroupsSelect = document.getElementById('editFlightGroups');
        const editSelectedGroupsDisplay = document.getElementById('editSelectedGroupsDisplay');
        const editSelectedGroupsBadges = editSelectedGroupsDisplay ? editSelectedGroupsDisplay.querySelector('.selected-groups-badges') : null;
        
        if (editFlightGroupsSelect && editSelectedGroupsDisplay && editSelectedGroupsBadges) {
            editFlightGroupsSelect.addEventListener('change', function() {
                updateSelectedGroupsDisplay(this, editSelectedGroupsDisplay, editSelectedGroupsBadges);
            });
        }
        
        // Add event listeners for edit and delete buttons in Upcoming Events tab
        document.querySelectorAll('.upcoming-events .edit-event-btn').forEach(button => {
            button.addEventListener('click', function() {
                const eventId = this.getAttribute('data-event-id');
                openEditEventModal(eventId);
            });
        });
        
        document.querySelectorAll('.upcoming-events .delete-event-btn').forEach(button => {
            button.addEventListener('click', function() {
                const eventId = this.getAttribute('data-event-id');
                const eventTitle = this.getAttribute('data-event-title');
                openDeleteEventModal(eventId, eventTitle);
            });
        });
        
        // Add event listeners for edit and delete buttons in Event History tab
        document.querySelectorAll('#eventHistoryTable .edit-event-btn').forEach(button => {
            button.addEventListener('click', function() {
                const eventId = this.getAttribute('data-event-id');
                openEditEventModal(eventId);
            });
        });
        
        document.querySelectorAll('#eventHistoryTable .delete-event-btn').forEach(button => {
            button.addEventListener('click', function() {
                const eventId = this.getAttribute('data-event-id');
                const eventTitle = this.getAttribute('data-event-title');
                openDeleteEventModal(eventId, eventTitle);
            });
        });
        
        // Set up delete confirmation button
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        if (confirmDeleteBtn) {
            confirmDeleteBtn.addEventListener('click', function() {
                const eventId = this.getAttribute('data-event-id');
                if (eventId) {
                    window.location.href = `/delete-event/${eventId}/`;
                }
            });
        }
    });
    
    // Show event details panel
    function showEventDetailsPanel(dateStr, eventsData) {
        const eventDetailsPanel = document.querySelector('.event-details-panel');
        const eventDetailsContent = document.querySelector('.event-details-content');
        const selectedDateTitle = document.querySelector('.selected-date');
        
        if (!eventDetailsPanel || !eventDetailsContent || !selectedDateTitle) {
            return;
        }
        
        // Format the date for display
        const dateObj = new Date(dateStr);
        const formattedDate = dateObj.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        selectedDateTitle.innerHTML = `<i class="fas fa-calendar-day me-2"></i> ${formattedDate}`;
        
        // Filter events for this date
        const dateEvents = eventsData.filter(event => event.date === dateStr);
        
        // Clear previous content
        eventDetailsContent.innerHTML = '';
        
        if (dateEvents.length === 0) {
            eventDetailsContent.innerHTML = `
                <div class="text-center py-3">
                    <i class="fas fa-calendar-times fa-2x mb-2 text-muted"></i>
                    <p class="mb-0">No events scheduled for this date.</p>
                </div>
            `;
        } else {
            // Create event cards
            dateEvents.forEach(event => {
                const eventCard = document.createElement('div');
                eventCard.className = 'card mb-2 border';
                eventCard.innerHTML = `
                    <div class="card-body p-3">
                        <h5 class="card-title">${event.title}</h5>
                        <p class="card-text small text-muted mb-2">
                            ${event.flight_group || ''}
                        </p>
                        <p class="card-text">${event.content || ''}</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary edit-event-btn" 
                                    data-event-id="${event.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-event-btn" 
                                    data-event-id="${event.id}"
                                    data-event-title="${event.title}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
                
                // Add event listeners to the new buttons
                const editBtn = eventCard.querySelector('.edit-event-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', function() {
                        openEditEventModal(event.id);
                    });
                }
                
                const deleteBtn = eventCard.querySelector('.delete-event-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function() {
                        openDeleteEventModal(event.id, event.title);
                    });
                }
                
                eventDetailsContent.appendChild(eventCard);
            });
        }
        
        // Show the panel
        eventDetailsPanel.classList.remove('d-none');
    }
    
    // Populate calendar with event counts and indicators
    function populateCalendarWithEvents(events) {
        // Reset all counts to zero
        document.querySelectorAll('.event-count').forEach(counter => {
            counter.textContent = '0';
        });
        
        // Clear all event indicators
        document.querySelectorAll('.event-indicator-container').forEach(container => {
            container.innerHTML = '';
        });
        
        // Count events per date and add indicators
        const eventsByDate = {};
        if (events && events.length) {
            events.forEach(event => {
                if (!eventsByDate[event.date]) {
                    eventsByDate[event.date] = [];
                }
                eventsByDate[event.date].push(event);
            });
            
            // Update the calendar with counts and indicators
            for (const date in eventsByDate) {
                const dateCell = document.querySelector(`.calendar-date[data-date="${date}"]`);
                if (dateCell) {
                    const countElement = dateCell.querySelector('.event-count');
                    const indicatorContainer = dateCell.querySelector('.event-indicator-container');
                    
                    if (countElement) {
                        countElement.textContent = eventsByDate[date].length;
                        
                        // Highlight dates with events
                        if (eventsByDate[date].length > 0) {
                            dateCell.classList.add('has-events');
                            // Make event count blue if there are events
                            countElement.classList.add('text-primary');
                            
                            // Add event indicators (max 3)
                            if (indicatorContainer) {
                                const maxIndicators = Math.min(eventsByDate[date].length, 3);
                                for (let i = 0; i < maxIndicators; i++) {
                                    const indicator = document.createElement('div');
                                    indicator.className = 'event-indicator bg-primary rounded-circle me-1';
                                    indicatorContainer.appendChild(indicator);
                                }
                                
                                // Add "more" indicator if needed
                                if (eventsByDate[date].length > 3) {
                                    const moreIndicator = document.createElement('div');
                                    moreIndicator.className = 'event-indicator-more small text-primary';
                                    moreIndicator.textContent = '+' + (eventsByDate[date].length - 3);
                                    indicatorContainer.appendChild(moreIndicator);
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    
    // Mark today's date
    function markTodayDate() {
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        const todayCell = document.querySelector(`.calendar-date[data-date="${todayStr}"]`);
        if (todayCell) {
            todayCell.classList.add('today');
            const dateNumber = todayCell.querySelector('.date-number');
            if (dateNumber) {
                dateNumber.classList.add('text-primary', 'fw-bold');
            }
        }
    }
    
    // Function to update the selected groups display
    function updateSelectedGroupsDisplay(selectElement, displayElement, badgesContainer) {
        if (!selectElement || !displayElement || !badgesContainer) {
            return;
        }
        
        const selectedOptions = Array.from(selectElement.selectedOptions);
        
        if (selectedOptions.length > 0) {
            displayElement.classList.remove('d-none');
            badgesContainer.innerHTML = '';
            
            selectedOptions.forEach(option => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-primary me-1 mb-1';
                badge.textContent = option.text;
                badgesContainer.appendChild(badge);
            });
        } else {
            displayElement.classList.add('d-none');
        }
    }
    
    // Open edit event modal function
    function openEditEventModal(eventId) {
        // Fetch event details via AJAX
        fetch(`/get-event-details/${eventId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Populate the edit form with event data
                document.getElementById('editEventTitle').value = data.title;
                document.getElementById('editEventDate').value = data.date;
                document.getElementById('editEventContent').value = data.content;
                
                // Set the form action URL
                document.getElementById('editEventForm').action = `/edit-event/${eventId}/`;
                
                // Handle flight groups (if using Select2)
                if (typeof $.fn.select2 !== 'undefined') {
                    // Clear previous selections
                    $('#editFlightGroups').val(null).trigger('change');
                    
                    // If we have flight_group_ids array, select them
                    if (data.flight_group_ids && Array.isArray(data.flight_group_ids)) {
                        $('#editFlightGroups').val(data.flight_group_ids).trigger('change');
                    } 
                    // Fallback to single flight_group_id if available
                    else if (data.flight_group_id) {
                        $('#editFlightGroups').val([data.flight_group_id]).trigger('change');
                    }
                }
                
                // Show the modal
                const editModal = new bootstrap.Modal(document.getElementById('editEventModal'));
                editModal.show();
            })
            .catch(error => {
                console.error('Error fetching event details:', error);
                alert('Failed to load event details. Please try again.');
            });
    }
    
    // Open delete event modal function
    function openDeleteEventModal(eventId, eventTitle) {
        // Set the event title in the modal
        document.getElementById('deleteEventTitle').textContent = eventTitle;
        
        // Set the delete confirmation link
        document.getElementById('confirmDeleteBtn').setAttribute('data-event-id', eventId);
        
        // Show the modal
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteEventModal'));
        deleteModal.show();
    }
</script>

<script>
    // Event History Export Functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Elements for export
        const exportEventsBtn = document.getElementById('exportEvents');
        const exportFormatItems = document.querySelectorAll('[data-format]');
        
        // Initialize export functionality
        if (exportEventsBtn) {
            exportEventsBtn.addEventListener('click', function() {
                // Default to CSV if no format selected
                exportEvents('csv');
            });
        }
        
        if (exportFormatItems && exportFormatItems.length > 0) {
            exportFormatItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const format = this.getAttribute('data-format');
                    if (format) {
                        exportEvents(format);
                    }
                });
            });
        }
        
        // Function to safely export events
        function exportEvents(format) {
            // Get the event history table
            const eventHistoryTable = document.getElementById('eventHistoryTable');
            if (!eventHistoryTable) {
                console.error('Event history table not found');
                alert('Cannot export: Event history table not found');
                return;
            }
            
            // Get visible rows only (respect current filters)
            const rows = eventHistoryTable.querySelectorAll('tbody tr:not([style*="display: none"])');
            if (!rows || rows.length === 0) {
                alert('No events to export. Please adjust your filters or add events.');
                return;
            }
            
            const events = [];
            
            // Safely extract data from each row
            rows.forEach(row => {
                try {
                    // Safely get cell content with fallbacks
                    const dateCell = row.querySelector('td:nth-child(1)');
                    const titleCell = row.querySelector('td:nth-child(2)');
                    const groupCell = row.querySelector('td:nth-child(3)');
                    
                    const date = dateCell ? dateCell.textContent.trim() : 'N/A';
                    const title = titleCell ? titleCell.textContent.trim() : 'N/A';
                    
                    // Get group badges if they exist
                    let groups = 'N/A';
                    if (groupCell) {
                        const groupBadges = groupCell.querySelectorAll('.badge');
                        if (groupBadges && groupBadges.length > 0) {
                            groups = Array.from(groupBadges)
                                .map(badge => badge.textContent.trim())
                                .join(', ');
                        } else {
                            // If no badges, just use the cell text
                            groups = groupCell.textContent.trim();
                        }
                    }
                    
                    events.push({
                        date: date,
                        title: title,
                        group: groups,
                        description: '', // We don't have this in the table
                        creator: ''      // We don't have this in the table
                    });
                } catch (error) {
                    console.error('Error processing row:', error);
                    // Continue with next row
                }
            });
            
            if (events.length === 0) {
                alert('Failed to extract event data. Please try again.');
                return;
            }
            
            // Export based on format
            try {
                if (format === 'csv') {
                    exportToCSV(events);
                } else if (format === 'excel') {
                    exportToExcel(events);
                } else if (format === 'pdf') {
                    exportToPDF(events);
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('An error occurred during export. Please try again.');
            }
        }
        
        // CSV Export
        function exportToCSV(events) {
            const headers = ['Date', 'Title', 'Flight Group'];
            let csvContent = headers.join(',') + '\n';
            
            events.forEach(event => {
                const row = [
                    `"${event.date.replace(/"/g, '""')}"`,
                    `"${event.title.replace(/"/g, '""')}"`,
                    `"${event.group.replace(/"/g, '""')}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'event_history.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Excel Export (simplified)
        function exportToExcel(events) {
            // For now, just use CSV which Excel can open
            exportToCSV(events);
            
            // Show a message about the limitation
            setTimeout(() => {
                alert('Note: Excel export is currently implemented as CSV. For proper Excel files, a library like SheetJS would be needed.');
            }, 500);
        }
        
        // PDF Export
        function exportToPDF(events) {
            // Get CSRF token
            const csrfToken = getCsrfToken();
            if (!csrfToken) {
                alert('CSRF token not found. Please refresh the page and try again.');
                return;
            }
            
            // Prepare data for server
            const data = {
                events: events
            };
            
            // Show loading indicator
            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-50';
            loadingIndicator.style.zIndex = '9999';
            loadingIndicator.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>';
            document.body.appendChild(loadingIndicator);
            
            // Send request to server
            fetch('/export-events-pdf/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                // Remove loading indicator
                document.body.removeChild(loadingIndicator);
                
                if (!response.ok) {
                    throw new Error('Server returned error: ' + response.status);
                }
                return response.blob();
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'event_history.pdf';
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                // Remove loading indicator if still present
                if (document.body.contains(loadingIndicator)) {
                    document.body.removeChild(loadingIndicator);
                }
                
                console.error('Error exporting to PDF:', error);
                alert('Failed to export to PDF: ' + error.message);
            });
        }
        
        // Helper function to get CSRF token
        function getCsrfToken() {
            // Try to get from cookie
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];
            
            if (cookieValue) return cookieValue;
            
            // Try to get from form
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            if (csrfInput) return csrfInput.value;
            
            // Try to get from meta tag
            const csrfMeta = document.querySelector('meta[name="csrf-token"]');
            if (csrfMeta) return csrfMeta.getAttribute('content');
            
            return '';
        }
    });
</script>

<script>
    // Event History Filter Functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Get filter elements
        const eventSearch = document.getElementById('eventSearch');
        const historyFlightGroupFilter = document.getElementById('historyFlightGroupFilter');
        const eventDateFilter = document.getElementById('eventDateFilter');
        const clearFiltersBtn = document.getElementById('clearFilters');
        const eventHistoryTable = document.getElementById('eventHistoryTable');
        
        // Check if elements exist before adding event listeners
        if (eventSearch) {
            eventSearch.addEventListener('input', applyFilters);
        }
        
        if (historyFlightGroupFilter) {
            historyFlightGroupFilter.addEventListener('change', applyFilters);
        }
        
        if (eventDateFilter) {
            eventDateFilter.addEventListener('change', applyFilters);
        }
        
        if (clearFiltersBtn) {
            clearFiltersBtn.addEventListener('click', function(e) {
                e.preventDefault();
                clearAllFilters();
            });
        }
        
        // Function to apply all filters
        function applyFilters() {
            if (!eventHistoryTable) {
                console.error('Event history table not found');
                return;
            }
            
            // Get filter values
            const searchText = eventSearch ? eventSearch.value.toLowerCase().trim() : '';
            const groupFilter = historyFlightGroupFilter ? historyFlightGroupFilter.value : 'all';
            const dateFilter = eventDateFilter ? eventDateFilter.value : '';
            
            // Get all rows in the table body
            const rows = eventHistoryTable.querySelectorAll('tbody tr');
            if (!rows || rows.length === 0) {
                console.log('No rows found in event history table');
                return;
            }
            
            let visibleCount = 0;
            
            // Loop through each row and apply filters
            rows.forEach(row => {
                try {
                    // Skip the "no results" row if it exists
                    if (row.classList.contains('no-results-row')) {
                        return;
                    }
                    
                    // Get cell values safely
                    const dateCell = row.querySelector('td:nth-child(1)');
                    const titleCell = row.querySelector('td:nth-child(2)');
                    const groupCell = row.querySelector('td:nth-child(3)');
                    
                    // Default to empty strings if cells don't exist
                    const dateText = dateCell ? dateCell.textContent.trim() : '';
                    const titleText = titleCell ? titleCell.textContent.trim().toLowerCase() : '';
                    
                    // Check if row matches search text
                    const matchesSearch = searchText === '' || titleText.includes(searchText);
                    
                    // Check if row matches date filter
                    const matchesDate = dateFilter === '' || (dateText && dateText.includes(dateFilter));
                    
                    // Check if row matches group filter
                    let matchesGroup = groupFilter === 'all';
                    
                    if (!matchesGroup && groupCell) {
                        // Try to find group badges first
                        const badges = groupCell.querySelectorAll('.badge');
                        
                        if (badges && badges.length > 0) {
                            // Check each badge to see if it matches the filter
                            badges.forEach(badge => {
                                const badgeText = badge.textContent.trim();
                                // Find the option text that corresponds to the selected value
                                if (historyFlightGroupFilter) {
                                    const selectedOption = historyFlightGroupFilter.querySelector(`option[value="${groupFilter}"]`);
                                    if (selectedOption && badgeText === selectedOption.textContent.trim()) {
                                        matchesGroup = true;
                                    }
                                }
                            });
                        } else {
                            // If no badges, check the cell text directly
                            const groupText = groupCell.textContent.trim();
                            if (historyFlightGroupFilter) {
                                const selectedOption = historyFlightGroupFilter.querySelector(`option[value="${groupFilter}"]`);
                                if (selectedOption && groupText.includes(selectedOption.textContent.trim())) {
                                    matchesGroup = true;
                                }
                            }
                        }
                    }
                    
                    // Show or hide row based on all filters
                    if (matchesSearch && matchesDate && matchesGroup) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error filtering row:', error);
                    // If there's an error, show the row by default
                    row.style.display = '';
                    visibleCount++;
                }
            });
            
            // Show "no results" message if no rows are visible
            updateNoResultsMessage(visibleCount);
        }
        
        // Function to show/hide "no results" message
        function updateNoResultsMessage(visibleCount) {
            if (!eventHistoryTable) return;
            
            // Remove existing "no results" row if it exists
            const existingNoResults = eventHistoryTable.querySelector('.no-results-row');
            if (existingNoResults) {
                existingNoResults.remove();
            }
            
            // Add "no results" row if needed
            if (visibleCount === 0) {
                const tbody = eventHistoryTable.querySelector('tbody');
                if (tbody) {
                    const noResultsRow = document.createElement('tr');
                    noResultsRow.className = 'no-results-row';
                    noResultsRow.innerHTML = `
                        <td colspan="5" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-search me-2"></i>No events match your filter criteria
                            </div>
                            <button class="btn btn-sm btn-outline-secondary mt-2" id="inlineResetFilters">
                                <i class="fas fa-times me-1"></i>Reset Filters
                            </button>
                        </td>
                    `;
                    tbody.appendChild(noResultsRow);
                    
                    // Add event listener to the inline reset button
                    const inlineResetBtn = noResultsRow.querySelector('#inlineResetFilters');
                    if (inlineResetBtn) {
                        inlineResetBtn.addEventListener('click', function() {
                            clearAllFilters();
                        });
                    }
                }
            }
        }
        
        // Function to clear all filters
        function clearAllFilters() {
            if (eventSearch) eventSearch.value = '';
            if (historyFlightGroupFilter) historyFlightGroupFilter.value = 'all';
            if (eventDateFilter) eventDateFilter.value = '';
            
            // Apply filters with cleared values
            applyFilters();
        }
        
        // Initialize filters on page load
        setTimeout(applyFilters, 100);
    });
</script>

<style>
/* Essential calendar styles */
.calendar-container {
    border: 1px solid #dee2e6;
    background-color: #fff;
}

.calendar-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 10px 0;
}

.calendar-day {
    text-align: center;
    font-weight: 600;
    color: #495057;
}

.calendar-body {
    display: flex;
    flex-direction: column;
}

.calendar-week {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    border-bottom: 1px solid #f0f0f0;
}

.calendar-date {
    position: relative;
    min-height: 80px;
    padding: 8px;
    border-right: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background-color 0.2s;
}

.calendar-date:hover {
    background-color: #f8f9fa;
}

.calendar-date.empty {
    background-color: #f9f9f9;
    cursor: default;
}

.calendar-date.sunday {
    background-color: #fff8f8;
}

.date-number {
    font-weight: 500;
    margin-bottom: 5px;
}

.event-count {
    font-size: 0.8rem;
    color: #6c757d;
}

/* Event indicator styles */
.event-indicator-container {
    display: flex;
    flex-wrap: wrap;
    position: absolute;
    bottom: 5px;
    left: 5px;
    right: 5px;
}

.event-indicator {
    width: 8px;
    height: 8px;
    margin-right: 2px;
    display: inline-block;
}

.event-indicator-more {
    font-size: 0.7rem;
}

.calendar-date.has-events {
    background-color: rgba(13, 110, 253, 0.05);
}

.calendar-date.has-events:hover {
    background-color: rgba(13, 110, 253, 0.1);
}

/* Popover customization */
.popover {
    max-width: 250px;
}

.popover-event-list {
    max-height: 200px;
    overflow-y: auto;
}

.popover-event {
    border-bottom: 1px solid #eee;
    padding-bottom: 5px;
}

.popover-event:last-child {
    border-bottom: none;
}

/* Event details panel */
.event-details-panel {
    background-color: #fff;
    transition: all 0.3s ease;
}

.event-details-content {
    max-height: 300px;
    overflow-y: auto;
}

/* Calendar navigation */
.calendar-navigation {
    margin-bottom: 20px;
}

.month-title {
    font-size: 1.5rem;
    margin: 0;
    text-align: center;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .calendar-date {
        min-height: 60px;
        padding: 5px;
    }
    
    .date-number {
        font-size: 0.9rem;
    }
    
    .event-count {
        font-size: 0.7rem;
    }
}

#eventTabs .nav-link {
    border: none;
    position: relative;
    transition: all 0.3s ease;
}

#eventTabs .nav-link:hover {
    background-color: rgba(13, 110, 253, 0.05);
}

#eventTabs .nav-link.active {
    border: none;
    background-color: transparent;
}

#eventTabs .nav-link.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background-color: #0d6efd;
    border-radius: 3px 3px 0 0;
}

#eventTabs .nav-link:not(.active) {
    color: #6c757d;
}

@media (max-width: 768px) {
    #eventTabs .nav-link {
        padding: 1rem 0.5rem;
    }
    
    #eventTabs small {
        display: none;
    }
}
</style>

{% endblock %} 