{% extends 'admin/base.html' %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/admin_dashboard.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<!-- Add AOS CSS -->
<link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css">

<!-- Add Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if user.is_staff %}
    <div class="admin-dashboard">        
        <div class="dashboard-header" data-aos="fade-up" data-aos-delay="100">
            <div class="header-logo">
                <img src="{% static 'img/logo.png' %}" alt="University Logo" class="dashboard-logo">
            </div>
            <div class="header-text">
                <h1>Admin Dashboard</h1>
                <p class="welcome-text">Welcome, {{ user.username }}!</p>
                <div class="datetime-container">
                    <div class="date-display">
                        <i class="fas fa-calendar-alt"></i>
                        <span id="currentDate"></span>
                    </div>
                    <div class="time-display">
                        <i class="fas fa-clock"></i>
                        <span id="currentTime"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Overview -->
        <div class="stats-overview" data-aos="fade-up" data-aos-delay="200">
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-header">
                        <i class="fas fa-users stat-icon"></i>
                        <span class="stat-number">{{ stats.total_personnel }}</span>
                    </div>
                    <h3>Users</h3>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-header">
                        <i class="fas fa-plane stat-icon"></i>
                        <span class="stat-number">{{ stats.total_groups }}</span>
                    </div>
                    <h3>Flight Groups</h3>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-header">
                        <i class="fas fa-file-alt stat-icon"></i>
                        <span class="stat-number">{{ stats.total_files }}</span>
                    </div>
                    <h3>Uploaded Files</h3>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-info">
                    <div class="stat-header">
                        <i class="fas fa-cloud-upload-alt stat-icon"></i>
                        <span class="stat-number">{{ stats.recent_uploads }}</span>
                    </div>
                    <h3>Recent Uploads</h3>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions-panel" data-aos="fade-up" data-aos-delay="200">
            <h2 class="panel-title"><i class="fas fa-bolt"></i> Quick Actions</h2>
            <div class="action-buttons">
                <a href="{% url 'add_personnel' %}" class="action-btn">
                    <div class="action-content">
                        <div class="action-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="action-text">
                            <span class="action-title">Add Personnel</span>
                            <span class="action-desc">Create new personnel records</span>
                        </div>
                    </div>
                    <div class="hover-indicator"></div>
                </a>
                <a href="{% url 'upload_excel' %}" class="action-btn">
                    <div class="action-content">
                        <div class="action-icon">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <div class="action-text">
                            <span class="action-title">Upload File</span>
                            <span class="action-desc">Import data from Excel</span>
                        </div>
                    </div>
                    <div class="hover-indicator"></div>
                </a>
                <a href="{% url 'admin_flight_groups' %}" class="action-btn">
                    <div class="action-content">
                        <div class="action-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="action-text">
                            <span class="action-title">Manage Groups</span>
                            <span class="action-desc">Organize flight groups</span>
                        </div>
                    </div>
                    <div class="hover-indicator"></div>
                </a>
                <a href="{% url 'assign_gender' %}" class="action-btn">
                    <div class="action-content">
                        <div class="action-icon">
                            <i class="fas fa-venus-mars"></i>
                        </div>
                        <div class="action-text">
                            <span class="action-title">Assign Gender</span>
                            <span class="action-desc">Update gender information</span>
                        </div>
                    </div>
                    <div class="hover-indicator"></div>
                </a>
            </div>
        </div>

        

        <!-- Charts Section -->
        <div class="dashboard-row" style="display: flex; gap: 20px;">
            <div class="dashboard-card" data-aos="fade-up" data-aos-delay="900" style="flex: 1;">
                <div class="card-header">
                    <h2><i class="fas fa-chart-pie"></i> Gender Distribution</h2>
                    <div class="chart-controls">
                        <button class="chart-toggle" data-chart="pie"><i class="fas fa-chart-pie"></i></button>
                        <button class="chart-toggle" data-chart="doughnut"><i class="fas fa-circle-notch"></i></button>
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                    <canvas id="genderChart"></canvas>
                    <div class="chart-legend" id="genderLegend"></div>
                </div>
            </div>

            <div class="dashboard-card" data-aos="fade-up" data-aos-delay="1000" style="flex: 1;">
                <div class="card-header">
                    <h2><i class="fas fa-chart-bar"></i> Flight Group Members</h2>
                    <div class="chart-controls">
                        <select id="groupChartView" class="chart-select">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="radar">Radar Chart</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                    <canvas id="groupChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Activity Sections -->
        <div class="activities-container" data-aos="fade-up" data-aos-delay="300">
            <div class="activities-grid">
                <!-- Recent Activity -->
                <div class="activity-card">
                    <div class="activity-header">
                        <h2><i class="fas fa-history"></i> Recent Activity</h2>
                        <input type="text" id="activitySearch" placeholder="Search activities...">
                    </div>
                    <div class="activity-content">
                        {% if recent_activities %}
                            {% for activity in recent_activities %}
                            <div class="activity-item">
                                <div class="activity-icon {% if activity.type == 'upload' %}upload{% else %}user{% endif %}">
                                    <i class="{% if activity.type == 'upload' %}fas fa-file-upload{% else %}fas fa-user-plus{% endif %}"></i>
                                </div>
                                <div class="activity-text">
                                    <p>{{ activity.description }}</p>
                                    <small><i class="fas fa-user"></i> {{ activity.user }} • <i class="fas fa-clock"></i> {{ activity.timestamp }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="no-data">No recent activities</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Login/Logout History -->
                <div class="activity-card">
                    <div class="activity-header">
                        <h2><i class="fas fa-sign-in-alt"></i> Login/Logout History</h2>
                    </div>
                    <div class="activity-content">
                        {% if recent_activities %}
                            {% for activity in recent_activities %}
                            <div class="activity-item">
                                <div class="activity-icon {% if activity.activity_type == 'login' %}login{% else %}logout{% endif %}">
                                    <i class="fas-{% if activity.activity_type == 'login' %}sign-in{% else %}sign-out{% endif %}-alt"></i>
                                </div>
                                <div class="activity-text">
                                    <p>{{ activity.user.username }} {{ activity.activity_type }}</p>
                                    <small><i class="fas fa-clock"></i> {{ activity.timestamp }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="no-data">No login/logout history</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Admin Profile Activities -->
                <div class="activity-card">
                    <div class="activity-header">
                        <h2><i class="fas fa-user-shield"></i> Admin Activities</h2>
                    </div>
                    <div class="activity-content">
                        {% if profile_activities %}
                            {% for activity in profile_activities %}
                            <div class="activity-item">
                                <div class="activity-icon admin">
                                    <i class="fas fa-user-cog"></i>
                                </div>
                                <div class="activity-text">
                                    <p>{{ activity.action }}</p>
                                    <small><i class="fas fa-user"></i> {{ activity.user }} • <i class="fas fa-clock"></i> {{ activity.timestamp|date:"M d, Y H:i" }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="no-data">No admin activities</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Data initialization script must come before chart scripts -->
        <script>
            // Gender data
            window.genderMale = "{{ stats.gender_male }}";
            window.genderFemale = "{{ stats.gender_female }}";
            window.genderNonbinary = "{{ stats.gender_nonbinary }}";
            window.genderOther = "{{ stats.gender_other }}";
            // Group data
            window.groupNames = "{{ group_names|safe }}";
            window.groupMembers = "{{ group_members }}";
        </script>

        <!-- Then include your JavaScript files -->
        <script src="{% static 'js/admin_charts.js' %}"></script>
        <script src="{% static 'js/admin_datetime.js' %}"></script>

        <!-- JavaScript imports -->
        <script src="{% static 'js/admin_activities.js' %}"></script>
        <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

        <!-- Add this script before the closing </div> of admin-dashboard -->
      
    </div>
{% else %}
    <p>You do not have permission to access this page.</p>
{% endif %}
{% endblock %}