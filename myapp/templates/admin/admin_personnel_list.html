{% extends 'admin/base.html' %}
{% load static %}
{% load personnel_tags %}

{% block title %}Personnel & Flight Groups{% endblock %}

{% block content %}
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>
  AOS.init();
</script>

<div class="container-fluid mt-4">
    <!-- Page Header Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="accordion" id="infoAccordion">
                        <div class="accordion-item border-0">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                        <i class="fa-solid fa-users-line text-primary fa-2x"></i>
                                    </div>
                                </div>
                                <div class="col">
                                    <h1 class="h3 mb-2">Personnel & Flight Groups</h1>
                                    <div class="accordion-header" id="headingInfo">
                                        <button class="accordion-button bg-transparent shadow-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInfo" aria-expanded="true" aria-controls="collapseInfo">
                                            View Details
                                        </button>
                                    </div>
                                    <div id="collapseInfo" class="accordion-collapse collapse show" aria-labelledby="headingInfo" data-bs-parent="#infoAccordion">
                                        <div class="accordion-body px-0">
                                            <p class="text-muted mb-0">
                                                View, manage, and keep track of all personnel records in one place.  
                                                Easily add new members, update existing information, and ensure accurate record-keeping.  
                                                Maintain an organized database to streamline personnel management and improve efficiency.
                                            </p>
                                            <hr class="my-3">
                                            <p class="text-muted mb-0">
                                                Organize personnel into flight groups for better coordination and management.
                                                Create, edit and manage flight groups to structure your organization effectively.
                                                Track group assignments and maintain clear hierarchies within your personnel system.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Row -->
    <div class="row g-3 mb-4">
        <!-- Quick Actions Card -->
        <div class="col-12 col-md-3">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title d-flex align-items-center">
                        <i class="fas fa-bolt me-2"></i><span class="h5 mb-0">Quick Actions</span>
                    </h6>
                    <p class="text-muted small mb-3">
                        Use the options below to quickly manage personnel and flight groups. You can add new personnel, create flight groups, or assign gender to existing personnel with just a few clicks.
                    </p>
                    <div class="d-grid gap-3">
                        <button class="btn btn-primary btn-lg py-1" data-bs-toggle="modal" data-bs-target="#addPersonnelModal">
                            <i class="fas fa-plus-circle me-2"></i>Add New Personnel
                        </button>
                        
                        <button class="btn btn-primary btn-lg py-1" data-bs-toggle="modal" data-bs-target="#addFlightGroupModal">
                            <i class="fas fa-layer-group me-2"></i>Create Flight Group/Special Cases
                        </button>
                        
                        <a href="{% url 'assign_gender' %}" class="btn btn-primary btn-lg py-1">
                            <i class="fas fa-users-cog me-2"></i>Assign or Update Gender
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="col-12 col-md-9">
            <div class="accordion" id="statisticsAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="statisticsHeader">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#statisticsCollapse" aria-expanded="true" aria-controls="statisticsCollapse">
                            Personnel Statistics
                        </button>
                    </h2>
                    <div id="statisticsCollapse" class="accordion-collapse collapse show" aria-labelledby="statisticsHeader">
                        <div class="accordion-body">
                            <div class="row g-3">
                                <!-- Total Personnel -->
                                <div class="col-12 col-sm-6 col-md-4">
                                    <div class="card bg-primary text-white">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-black bg-opacity-25 p-2 me-3">
                                                    <i class="fas fa-users fa-lg"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">Total Personnel</h6>
                                                    <h3 class="mb-0">{{ personnel.count }}</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Active Personnel -->
                                <div class="col-12 col-sm-6 col-md-4">
                                    <div class="card bg-success text-white">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-black bg-opacity-25 p-2 me-3">
                                                    <i class="fas fa-user-check fa-lg"></i>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0">Active</h6>
                                                    <h3 class="mb-0">{{ active_count }}</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Gender Distribution -->
                                <div class="col-12 col-sm-6 col-md-4">
                                    <div class="card bg-warning text-white">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-black bg-opacity-25 p-2 me-3">
                                                    <i class="fas fa-venus-mars fa-lg"></i>
                                                </div>
                                                <div class="d-flex gap-3">
                                                    <div>
                                                        <h6 class="mb-0">Male</h6>
                                                        <h3 class="mb-0">{{ male_count }}</h3>
                                                    </div>
                                                    <div>
                                                        <h6 class="mb-0">Female</h6>
                                                        <h3 class="mb-0">{{ female_count }}</h3>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row g-3">
        <!-- Search and Filter Section -->
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body p-3">
                    <p class="text-muted mb-3">Use the search, sort and filter options below to find specific personnel records.</p>
                    <div class="row g-2">
                        <div class="col-12 col-md-4">
                            <div class="input-group">
                                <span class="input-group-text bg-transparent">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       id="searchInput" 
                                       class="form-control" 
                                       placeholder="Search personnel...">
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="input-group">
                                <span class="input-group-text bg-transparent">
                                    <i class="fas fa-sort"></i>
                                </span>
                                <select id="sortSelect" class="form-select">
                                    <option value="name_asc">Name (A-Z)</option>
                                    <option value="name_desc">Name (Z-A)</option>
                                    <option value="position_asc">Position (A-Z)</option>
                                    <option value="position_desc">Position (Z-A)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="input-group">
                                <span class="input-group-text bg-transparent">
                                    <i class="fas fa-filter"></i>
                                </span>
                                <select class="form-select">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Simple Bootstrap Tab Navigation -->
        <div class="col-12">
            <div class="card shadow-sm">
                <!-- Simple Tab Navigation -->
                <ul class="nav nav-tabs" id="personnelTabs">
                    <li class="nav-item">
                        <a class="nav-link active" id="personnel-tab" data-bs-toggle="tab" href="#personnel-content">
                            <i class="fas fa-users me-1"></i> Personnel List
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="flight-groups-tab" data-bs-toggle="tab" href="#flight-groups-content">
                            <i class="fas fa-layer-group me-1"></i> Flight Groups
                        </a>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content p-0" id="personnelTabsContent">
                    <!-- Personnel Tab Content -->
                    <div class="tab-pane fade show active" id="personnel-content" role="tabpanel">
                        <div class="row g-0">
                            <div class="col-12 col-xl-9">
                                <!-- Messages -->
                                {% if messages %}
                                    {% for message in messages %}
                                        <div class="alert alert-info alert-dismissible fade show m-3">
                                            {{ message }}
                                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                        </div>
                                    {% endfor %}
                                {% endif %}

                                <!-- Bulk Actions -->
                                <div class="d-none m-3" id="bulkActions">
                                    <button id="bulkDeleteBtn" class="btn btn-danger btn-sm">
                                        <i class="fas fa-trash"></i> Delete Selected (<span id="selectedCount">0</span>)
                                    </button>
                                </div>

                                <!-- Personnel Table Card -->
                                <div class="card shadow-sm m-3">
                                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Personnel List</h5>
                                        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#personnelAccordion" aria-expanded="true">
                                            <i class="fas fa-chevron-down"></i> Toggle View
                                        </button>
                                    </div>
                                    <div class="collapse show" id="personnelAccordion">
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-hover align-middle mb-0" id="personnelTable">
                                                    <thead class="bg-light">
                                                        <tr>
                                                            <th class="px-3" style="width: 40px;">
                                                                <input type="checkbox" id="selectAll" class="form-check-input">
                                                            </th>
                                                            <th class="d-none d-md-table-cell px-3" style="width: 60px;">Profile</th>
                                                            <th class="px-3" style="width: 200px;">Name</th>
                                                            <th class="d-none d-md-table-cell px-3" style="width: 120px;">Student ID</th>
                                                            <th class="d-none d-md-table-cell px-3" style="width: 150px;">Position</th>
                                                            <th class="px-3" style="width: 100px;">Status</th>
                                                            <th class="d-none d-lg-table-cell px-3" style="width: 120px;">Flight Group</th>
                                                            <th class="d-none d-lg-table-cell px-3" style="width: 120px;">Contact</th>
                                                            <th class="d-none d-lg-table-cell px-3" style="width: 140px;">Gender Assignment</th>
                                                            <th class="px-3" style="width: 150px;">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for person in personnel %}
                                                        <tr>
                                                            <td class="px-3">
                                                                <input type="checkbox" class="form-check-input personnel-checkbox" 
                                                                       value="{{ person.id }}">
                                                            </td>
                                                            <td class="d-none d-md-table-cell px-3">
                                                                {% if person.profile_picture %}
                                                                    <img src="{{ person.profile_picture.url }}" 
                                                                         class="rounded-circle" 
                                                                         alt="Profile Picture"
                                                                         width="40" height="40"
                                                                         data-bs-toggle="modal" 
                                                                         data-bs-target="#imageModal{{ person.id }}">
                                                                {% else %}
                                                                    <img src="{% static 'images/default-profile.png' %}" 
                                                                         class="rounded-circle" 
                                                                         alt="Default Profile"
                                                                         width="40" height="40"
                                                                         data-bs-toggle="modal" 
                                                                         data-bs-target="#imageModal{{ person.id }}">
                                                                {% endif %}
                                                            </td>
                                                            <td class="px-3">
                                                                <div>
                                                                    <div class="fw-bold">{{ person.first_name }} {{ person.last_name }}</div>
                                                                    <div class="text-muted small">@{{ person.user.username }}</div>
                                                                    <!-- Mobile-only info -->
                                                                    <div class="d-md-none text-muted small">
                                                                        <div>{{ person.position }}</div>
                                                                        <div>ID: {{ person.student_id }}</div>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td class="d-none d-md-table-cell px-3">{{ person.student_id }}</td>
                                                            <td class="d-none d-md-table-cell px-3">{{ person.position }}</td>
                                                            <td class="px-3">
                                                                <span class="badge {% if person.status == 'Active' %}bg-success{% else %}bg-warning{% endif %}">
                                                                    {{ person.status }}
                                                                </span>
                                                            </td>
                                                            <td class="d-none d-lg-table-cell px-3">
                                                                {% if person.flight_group %}
                                                                    {{ person.flight_group.name }}
                                                                {% else %}
                                                                    <span class="text-muted">None</span>
                                                                {% endif %}
                                                            </td>
                                                            <td class="d-none d-lg-table-cell px-3">{{ person.phone_number }}</td>
                                                            <td class="d-none d-lg-table-cell px-3">{{ person.gender_assignment|default:"Not Assigned" }}</td>
                                                            <td class="px-3">
                                                                <div class="btn-group">
                                                                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" 
                                                                            data-bs-target="#viewPersonnelModal{{ person.id }}">
                                                                        <i class="fas fa-eye"></i><span class="d-none d-md-inline ms-1">View</span>
                                                                    </button>
                                                                    <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" 
                                                                            data-bs-target="#editPersonnelModal{{ person.id }}">
                                                                        <i class="fas fa-edit"></i><span class="d-none d-md-inline ms-1">Edit</span>
                                                                    </button>
                                                                    <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" 
                                                                            data-bs-target="#deletePersonnelModal{{ person.id }}">
                                                                        <i class="fas fa-trash"></i><span class="d-none d-md-inline ms-1">Delete</span>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Personnel Details Accordion -->
                                <div class="card shadow-sm m-3">
                                    <div class="card-header bg-white">
                                        <div class="accordion" id="personnelDetailsAccordion">
                                            {% for person in personnel %}
                                            <div class="accordion-item border-0">
                                                <h2 class="accordion-header" id="heading{{ person.id }}">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                            data-bs-target="#collapse{{ person.id }}" aria-expanded="false" 
                                                            aria-controls="collapse{{ person.id }}">
                                                        <div class="d-flex align-items-center w-100">
                                                            <div class="me-3">
                                                                {% if person.profile_picture %}
                                                                    <img src="{{ person.profile_picture.url }}" 
                                                                         class="rounded-circle" 
                                                                         alt="Profile Picture"
                                                                         width="40" height="40">
                                                                {% else %}
                                                                    <img src="{% static 'images/default-profile.png' %}" 
                                                                         class="rounded-circle" 
                                                                         alt="Default Profile"
                                                                         width="40" height="40">
                                                                {% endif %}
                                                            </div>
                                                            <div>
                                                                <div class="fw-bold">{{ person.first_name }} {{ person.last_name }}</div>
                                                                <div class="text-muted small">{{ person.position }}</div>
                                                            </div>
                                                            <div class="ms-auto">
                                                                <span class="badge {% if person.status == 'Active' %}bg-success{% else %}bg-warning{% endif %}">
                                                                    {{ person.status }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </button>
                                                </h2>
                                                <div id="collapse{{ person.id }}" class="accordion-collapse collapse" 
                                                     aria-labelledby="heading{{ person.id }}" data-bs-parent="#personnelDetailsAccordion">
                                                    <div class="accordion-body">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <h6 class="mb-3"><i class="fas fa-user-circle me-2"></i>Basic Information</h6>
                                                                <div class="mb-2">
                                                                    <label class="text-muted small d-block">Student ID</label>
                                                                    <span>{{ person.student_id }}</span>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="text-muted small d-block">Age</label>
                                                                    <span>{{ person.age }}</span>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="text-muted small d-block">Gender</label>
                                                                    <span>{{ person.gender }}</span>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="text-muted small d-block">Gender Assignment</label>
                                                                    <span>{{ person.gender_assignment|default:"Not Assigned" }}</span>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Additional Information</h6>
                                                                <div class="mb-2">
                                                                    <label class="text-muted small d-block">Phone Number</label>
                                                                    <span>{{ person.phone_number }}</span>
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="text-muted small d-block">Flight Group</label>
                                                                    {% if person.flight_group %}
                                                                        <span>{{ person.flight_group.name }}</span>
                                                                    {% else %}
                                                                        <span class="text-muted">None</span>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="mb-2">
                                                                    <label class="text-muted small d-block">Username</label>
                                                                    <span>@{{ person.user.username }}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="mt-3 d-flex justify-content-end">
                                                            <button class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" 
                                                                    data-bs-target="#viewPersonnelModal{{ person.id }}">
                                                                <i class="fas fa-eye me-1"></i>View Details
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-success me-2" data-bs-toggle="modal" 
                                                                    data-bs-target="#editPersonnelModal{{ person.id }}">
                                                                <i class="fas fa-edit me-1"></i>Edit
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" 
                                                                    data-bs-target="#deletePersonnelModal{{ person.id }}">
                                                                <i class="fas fa-trash me-1"></i>Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Side Panel -->
                            <div class="col-12 col-xl-3">
                                <div class="row g-3 m-3">
                                    <!-- Statistics card -->
                                    <div class="col-12 col-md-6 col-xl-12">
                                        <div class="card shadow-sm">
                                            <div class="card-body p-3">
                                                <div class="d-flex justify-content-between align-items-center mb-3">
                                                    <h6 class="fw-semibold mb-0">Overview</h6>
                                                    <button class="btn btn-sm btn-outline-primary" id="zoomChartBtn">
                                                        <i class="fas fa-search-plus"></i>
                                                    </button>
                                                </div>
                                                <div class="chart-container" style="position: relative; height: 200px;">
                                                    <canvas id="personnelChart"></canvas>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Quick Stats -->
                                    <div class="col-12 col-md-6 col-xl-12">
                                        <div class="card shadow-sm">
                                            <div class="card-body p-3">
                                                <h6 class="fw-semibold mb-3">Quick Stats</h6>
                                                <div class="quick-stat mb-2">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="text-muted">Active Personnel</span>
                                                        <span class="badge bg-success" id="activePercentage">0%</span>
                                                    </div>
                                                    <div class="progress" style="height: 4px;">
                                                        <div class="progress-bar bg-success" id="activeProgressBar" style="width: 0%"></div>
                                                    </div>
                                                </div>
                                                <div class="quick-stat mb-2">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="text-muted">Assigned Groups</span>
                                                        <span class="badge bg-primary" id="assignedPercentage">0%</span>
                                                    </div>
                                                    <div class="progress" style="height: 4px;">
                                                        <div class="progress-bar bg-primary" id="assignedProgressBar" style="width: 0%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Flight Groups Tab Content -->
                    <div class="tab-pane fade" id="flight-groups-content" role="tabpanel">
                        <div class="p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Flight Groups</h5>
                                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addFlightGroupModal">
                                    <i class="fas fa-plus"></i> Add Flight Group
                                </button>
                            </div>
                            
                            <div class="row g-3">
                                {% for group in flight_groups %}
                                <div class="col-md-4 col-lg-3">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-body">
                                            <h5 class="card-title">{{ group.name }}</h5>
                                            <p class="card-text small text-muted">{{ group.description|truncatechars:100 }}</p>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="badge bg-info">{{ group.id|get_flight_group_members }} members</span>
                                                <div>
                                                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editFlightGroupModal{{ group.id }}">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteFlightGroupModal{{ group.id }}">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i> No flight groups have been created yet. Click "Add Flight Group" to create one.
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Personnel Modal -->
<div class="modal fade" id="addPersonnelModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Add Personnel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'add_personnel' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-user"></i> Username</label>
                            <input type="text" name="username" class="form-control form-control-sm" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-key"></i> Password</label>
                            <input type="password" name="password" class="form-control form-control-sm" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-user"></i> First Name</label>
                            <input type="text" name="first_name" class="form-control form-control-sm" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-user"></i> Last Name</label>
                            <input type="text" name="last_name" class="form-control form-control-sm" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-briefcase"></i> Position</label>
                            <input type="text" name="position" class="form-control form-control-sm" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-info-circle"></i> Status</label>
                            <select name="status" class="form-control form-control-sm" required>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-id-card"></i> Student ID</label>
                            <input type="text" name="student_id" class="form-control form-control-sm" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-birthday-cake"></i> Age</label>
                            <input type="number" name="age" class="form-control form-control-sm" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-venus-mars"></i> Gender</label>
                            <select name="gender" class="form-control form-control-sm" required>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number</label>
                            <input type="text" name="phone_number" class="form-control form-control-sm" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-users"></i> Flight Group</label>
                            <select name="flight_group" class="form-control form-control-sm">
                                <option value="">None</option>
                                {% for group in flight_groups %}
                                    <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-image"></i> Profile Picture</label>
                            <input type="file" name="profile_picture" class="form-control form-control-sm">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-sm btn-primary">Add Personnel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Include Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/personnel_list.js' %}"></script>

<!-- Add this for no results message -->
<div class="no-results" style="display: none;">
    <i class="fas fa-search"></i>
    <p>No personnel found matching your search.</p>
</div>

<!-- Image Preview Modal -->
{% for person in personnel %}
<div class="modal fade" id="imageModal{{ person.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">{{ person.first_name }} {{ person.last_name }}'s Profile Picture</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-0">
                {% if person.profile_picture %}
                    <img src="{{ person.profile_picture.url }}" 
                         class="img-fluid profile-preview" 
                         alt="Profile Picture">
                {% else %}
                    <img src="{% static 'images/default-profile.png' %}" 
                         class="img-fluid profile-preview" 
                         alt="Default Profile">
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Delete Confirmation Modal -->
{% for person in personnel %}
<div class="modal fade" id="deletePersonnelModal{{ person.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle text-danger"></i> Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong>{{ person.first_name }} {{ person.last_name }}</strong>?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'delete_personnel' person.id %}" class="btn btn-sm btn-danger">
                    <i class="fas fa-trash"></i> Delete Personnel
                </a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Add this new modal for bulk delete confirmation -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-danger"></i> 
                    Confirm Bulk Delete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <span id="deleteCount">0</span> selected personnel?</p>
                <p class="text-danger">This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmBulkDelete">
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Add this modal for the zoomed chart -->
<div class="modal fade" id="chartZoomModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Personnel Distribution</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="zoomed-chart-container" style="position: relative; height: 400px;">
                    <canvas id="zoomedPersonnelChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add back the Edit and View Personnel Modals -->
{% for person in personnel %}
<!-- Edit Personnel Modal -->
<div class="modal fade" id="editPersonnelModal{{ person.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Personnel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'edit_personnel' person.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-user"></i> Username</label>
                            <input type="text" name="username" class="form-control form-control-sm" 
                                   value="{{ person.user.username }}" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-key"></i> Password</label>
                            <input type="password" name="password" class="form-control form-control-sm" 
                                   placeholder="Leave blank to keep current password">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-user"></i> First Name</label>
                            <input type="text" name="first_name" class="form-control form-control-sm" 
                                   value="{{ person.first_name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-user"></i> Last Name</label>
                            <input type="text" name="last_name" class="form-control form-control-sm" 
                                   value="{{ person.last_name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-briefcase"></i> Position</label>
                            <input type="text" name="position" class="form-control form-control-sm" 
                                   value="{{ person.position }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-info-circle"></i> Status</label>
                            <select name="status" class="form-control form-control-sm" required>
                                <option value="Active" {% if person.status == 'Active' %}selected{% endif %}>Active</option>
                                <option value="Inactive" {% if person.status == 'Inactive' %}selected{% endif %}>Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-id-card"></i> Student ID</label>
                            <input type="text" name="student_id" class="form-control form-control-sm" 
                                   value="{{ person.student_id }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-birthday-cake"></i> Age</label>
                            <input type="number" name="age" class="form-control form-control-sm" 
                                   value="{{ person.age }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-venus-mars"></i> Gender</label>
                            <select name="gender" class="form-control form-control-sm" required>
                                <option value="Male" {% if person.gender == 'Male' %}selected{% endif %}>Male</option>
                                <option value="Female" {% if person.gender == 'Female' %}selected{% endif %}>Female</option>
                                <option value="Other" {% if person.gender == 'Other' %}selected{% endif %}>Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-phone"></i> Phone Number</label>
                            <input type="text" name="phone_number" class="form-control form-control-sm" 
                                   value="{{ person.phone_number }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-users"></i> Flight Group</label>
                            <select name="flight_group" class="form-control form-control-sm">
                                <option value="">None</option>
                                {% for group in flight_groups %}
                                    <option value="{{ group.id }}" 
                                        {% if person.flight_group.id == group.id %}selected{% endif %}>
                                        {{ group.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-image"></i> Profile Picture</label>
                            <input type="file" name="profile_picture" class="form-control form-control-sm">
                            {% if person.profile_picture %}
                                <small class="text-muted">Current: {{ person.profile_picture.name }}</small>
                            {% endif %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-sm btn-primary">Update Personnel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- View Personnel Modal -->
<div class="modal fade" id="viewPersonnelModal{{ person.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header border-0 bg-light">
                <h5 class="modal-title"><i class="fas fa-user"></i> Personnel Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-3">
                <!-- Profile Header -->
                <div class="text-center mb-3">
                    {% if person.profile_picture %}
                        <img src="{{ person.profile_picture.url }}" 
                             class="rounded-circle shadow-sm" 
                             style="width: 80px; height: 80px; object-fit: cover;"
                             alt="Profile Picture">
                    {% else %}
                        <img src="{% static 'images/default-profile.png' %}" 
                             class="rounded-circle shadow-sm" 
                             style="width: 80px; height: 80px; object-fit: cover;"
                             alt="Default Profile">
                    {% endif %}
                    <h5 class="mt-2 mb-0">{{ person.first_name }} {{ person.last_name }}</h5>
                    <p class="text-muted small">@{{ person.user.username }}</p>
                </div>

                <!-- Info Cards -->
                <div class="row g-2">
                    <!-- Basic Info Card -->
                    <div class="col-12">
                        <div class="card border-0 shadow-sm mb-2">
                            <div class="card-body p-3">
                                <h6 class="mb-2"><i class="fas fa-user-circle me-2"></i>Basic Information</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="text-muted small d-block">Position</label>
                                        <span>{{ person.position }}</span>
                                    </div>
                                    <div class="col-6">
                                        <label class="text-muted small d-block">Status</label>
                                        <span class="badge bg-{% if person.status == 'Active' %}success{% else %}warning{% endif %}">
                                            {{ person.status }}
                                        </span>
                                    </div>
                                    <div class="col-6">
                                        <label class="text-muted small d-block">Student ID</label>
                                        <span>{{ person.student_id }}</span>
                                    </div>
                                    <div class="col-6">
                                        <label class="text-muted small d-block">Age</label>
                                        <span>{{ person.age }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Info Card -->
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-3">
                                <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Additional Information</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="text-muted small d-block">Gender</label>
                                        <span>{{ person.gender }}</span>
                                    </div>
                                    <div class="col-6">
                                        <label class="text-muted small d-block">Phone Number</label>
                                        <span>{{ person.phone_number }}</span>
                                    </div>
                                    <div class="col-6">
                                        <label class="text-muted small d-block">Flight Group</label>
                                        {% if person.flight_group %}
                                            <span>{{ person.flight_group.name }}</span>
                                        {% else %}
                                            <span class="text-muted">None</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-6">
                                        <label class="text-muted small d-block">Gender Assignment</label>
                                        <span>{{ person.gender_assignment|default:"Not Assigned" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Add Flight Group Modal -->
<div class="modal fade" id="addFlightGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Add Flight Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'admin_flight_groups' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Flight Group
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Flight Group Modals -->
{% for group in flight_groups %}
<div class="modal fade" id="editFlightGroupModal{{ group.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Flight Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'edit_flight_group' group.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" value="{{ group.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="3">{{ group.description }}</textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update Flight Group
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Flight Group Modal -->
<div class="modal fade" id="deleteFlightGroupModal{{ group.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-trash text-danger"></i> Delete Flight Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the flight group <strong>{{ group.name }}</strong>?</p>
                <p class="text-danger">This action cannot be undone. Personnel in this group will no longer be assigned to any group.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <a href="{% url 'delete_flight_group' group.id %}" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Delete Flight Group
                </a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Your existing personnel list JavaScript code...
    });
</script>
{% endblock %}