{% extends 'admin/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Assigned Personnel{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/admin_assigned_personnel.css' %}">
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0 text-gray-800">
            <i class="fas fa-users-cog me-2"></i> Personnel-Student Assignments
        </h2>
        <div>
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#autoAssignModal">
                <i class="fas fa-magic me-1"></i> Auto-Assign Students
            </button>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#resetAssignmentsModal">
                <i class="fas fa-undo-alt me-2"></i>Reset All Assignments
            </button>
        </div>
    </div>

    <!-- Personnel Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Personnel Assignments</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="personnelTable" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Personnel</th>
                            <th>Gender</th>
                            <th>Position</th>
                            <th>Assigned Students</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for personnel in personnel_list %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    {% if personnel.profile_picture %}
                                        <img src="{{ personnel.profile_picture.url }}" alt="Profile" class="rounded-circle me-2" width="40" height="40">
                                    {% else %}
                                        <i class="fas fa-user-circle me-2" style="font-size: 24px;"></i>
                                    {% endif %}
                                    {{ personnel.first_name }} {{ personnel.last_name }}
                                </div>
                            </td>
                            <td>{{ personnel.gender }}</td>
                            <td>{{ personnel.position }}</td>
                            <td>
                                {% with assigned_students=personnel_assignments|get_item:personnel.id %}
                                    {% if assigned_students %}
                                        <div class="assigned-students">
                                            {% for student in assigned_students %}
                                                <div class="student-badge d-flex align-items-center mb-1">
                                                    <span class="badge bg-primary me-2">{{ student.student_no }}</span>
                                                    {{ student.name }}
                                                    <div class="ms-auto">
                                                        <button type="button" class="btn btn-sm btn-info reassign-btn"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#reassignStudentModal"
                                                                data-student-id="{{ student.id }}"
                                                                data-student-name="{{ student.name }}"
                                                                data-current-personnel-id="{{ personnel.id }}"
                                                                data-current-personnel-name="{{ personnel.first_name }} {{ personnel.last_name }}">
                                                            <i class="fas fa-exchange-alt"></i>
                                                        </button>
                                                        {% with assignment=student.personnelstudentassignment_set.first %}
                                                            {% if assignment %}
                                                                <a href="{% url 'remove_student_assignment' assignment_id=assignment.id %}" 
                                                                   class="btn btn-sm btn-danger" 
                                                                   onclick="return confirm('Are you sure you want to remove this assignment?')">
                                                                    <i class="fas fa-times-circle"></i>
                                                                </a>
                                                            {% endif %}
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        <div class="mt-2">
                                            <span class="badge bg-info">Total: {{ assigned_students|length }}</span>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">No students assigned</span>
                                    {% endif %}
                                {% endwith %}
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary assign-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#assignStudentModal"
                                        data-personnel-id="{{ personnel.id }}"
                                        data-personnel-name="{{ personnel.first_name }} {{ personnel.last_name }}">
                                    <i class="fas fa-user-plus"></i> Assign
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Unassigned Students Section -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Unassigned Students</h6>
        </div>
        <div class="card-body">
            {% if unassigned_students %}
                <div class="row">
                    {% for student in unassigned_students %}
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">{{ student.name }}</h5>
                                    <p class="card-text">Student #: {{ student.student_no }}</p>
                                    <button type="button" class="btn btn-sm btn-primary assign-student-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#assignPersonnelModal"
                                            data-student-id="{{ student.id }}"
                                            data-student-name="{{ student.name }}">
                                        <i class="fas fa-user-plus"></i> Assign to Personnel
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-center">All students have been assigned.</p>
            {% endif %}
        </div>
    </div>

    <!-- Auto Assign Modal -->
    <div class="modal fade" id="autoAssignModal" tabindex="-1" aria-labelledby="autoAssignModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="autoAssignModalLabel">Auto-Assign Students</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'auto_assign_students' %}" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <p>This will automatically assign unassigned students to personnel based on gender matching.</p>
                        <p>Currently <strong>{{ unassigned_count }}</strong> unassigned students.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Auto-Assign</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assign Student Modal -->
    <div class="modal fade" id="assignStudentModal" tabindex="-1" aria-labelledby="assignStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignStudentModalLabel">Assign Student to Personnel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'manual_assign_student' %}" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" id="personnelId" name="personnel_id">
                        
                        <div class="mb-3">
                            <label class="form-label">Personnel:</label>
                            <div class="form-control" id="personnelName" readonly></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="studentSelect" class="form-label">Select Student:</label>
                            <select class="form-select" id="studentSelect" name="student_id" required>
                                <option value="" selected disabled>-- Select student --</option>
                                {% for student in unassigned_students %}
                                <option value="{{ student.id }}">
                                    {{ student.name }} ({{ student.student_no }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Assign</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assign Personnel Modal -->
    <div class="modal fade" id="assignPersonnelModal" tabindex="-1" aria-labelledby="assignPersonnelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignPersonnelModalLabel">Assign Personnel to Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'manual_assign_student' %}" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" id="studentId" name="student_id">
                        
                        <div class="mb-3">
                            <label class="form-label">Student:</label>
                            <div class="form-control" id="studentName" readonly></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="personnelSelect" class="form-label">Select Personnel:</label>
                            <select class="form-select" id="personnelSelect" name="personnel_id" required>
                                <option value="" selected disabled>-- Select personnel --</option>
                                {% for personnel in personnel_list %}
                                <option value="{{ personnel.id }}">
                                    {{ personnel.first_name }} {{ personnel.last_name }} ({{ personnel.gender }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Assign</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reassign Student Modal -->
    <div class="modal fade" id="reassignStudentModal" tabindex="-1" aria-labelledby="reassignStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reassignStudentModalLabel">Reassign Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'reassign_student' %}" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" id="reassignStudentId" name="student_id">
                        
                        <div class="mb-3">
                            <label class="form-label">Student:</label>
                            <div class="form-control" id="reassignStudentName" readonly></div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Current Personnel:</label>
                            <div class="form-control" id="currentPersonnelName" readonly></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="newPersonnelSelect" class="form-label">Select New Personnel:</label>
                            <select class="form-select" id="newPersonnelSelect" name="new_personnel_id" required>
                                <option value="" selected disabled>-- Select new personnel --</option>
                                {% for personnel in personnel_list %}
                                <option value="{{ personnel.id }}">
                                    {{ personnel.first_name }} {{ personnel.last_name }} ({{ personnel.gender }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Reassign</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reset Assignments Confirmation Modal -->
    <div class="modal fade" id="resetAssignmentsModal" tabindex="-1" aria-labelledby="resetAssignmentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="resetAssignmentsModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Reset All Assignments
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Warning:</strong> This action will remove ALL student assignments from ALL personnel.
                    </div>
                    <p>Are you sure you want to reset all assignments? This action cannot be undone.</p>
                    <p class="mb-0"><strong>Total assignments to be removed:</strong> <span id="totalAssignmentsCount">{{ total_assignments }}</span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <form action="{% url 'reset_all_assignments' %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-undo-alt me-2"></i>Reset All Assignments
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle assign student button clicks
        const assignBtns = document.querySelectorAll('.assign-btn');
        assignBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const personnelId = this.getAttribute('data-personnel-id');
                const personnelName = this.getAttribute('data-personnel-name');
                
                document.getElementById('personnelId').value = personnelId;
                document.getElementById('personnelName').textContent = personnelName;
            });
        });
        
        // Handle assign personnel button clicks
        const assignStudentBtns = document.querySelectorAll('.assign-student-btn');
        assignStudentBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const studentId = this.getAttribute('data-student-id');
                const studentName = this.getAttribute('data-student-name');
                
                document.getElementById('studentId').value = studentId;
                document.getElementById('studentName').textContent = studentName;
            });
        });

        // Handle reassign student button clicks
        const reassignBtns = document.querySelectorAll('.reassign-btn');
        reassignBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering the student details modal
                const studentId = this.getAttribute('data-student-id');
                const studentName = this.getAttribute('data-student-name');
                const currentPersonnelId = this.getAttribute('data-current-personnel-id');
                const currentPersonnelName = this.getAttribute('data-current-personnel-name');
                
                document.getElementById('reassignStudentId').value = studentId;
                document.getElementById('reassignStudentName').textContent = studentName;
                document.getElementById('currentPersonnelName').textContent = currentPersonnelName;
                
                // Disable the current personnel in the dropdown
                const newPersonnelSelect = document.getElementById('newPersonnelSelect');
                for (let i = 0; i < newPersonnelSelect.options.length; i++) {
                    if (newPersonnelSelect.options[i].value === currentPersonnelId) {
                        newPersonnelSelect.options[i].disabled = true;
                    } else {
                        newPersonnelSelect.options[i].disabled = false;
                    }
                }
            });
        });

        // Handle student details modal
        const studentDetailsModal = document.getElementById('studentDetailsModal');
        studentDetailsModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const studentId = button.getAttribute('data-student-id');
            const studentName = button.getAttribute('data-student-name');
            const studentNo = button.getAttribute('data-student-no');
            const studentGender = button.getAttribute('data-student-gender');
            const studentCourse = button.getAttribute('data-student-course');
            const studentYear = button.getAttribute('data-student-year');
            
            // Update modal content
            document.getElementById('modalStudentName').textContent = studentName;
            document.getElementById('modalStudentNo').textContent = studentNo;
            document.getElementById('modalStudentGender').textContent = studentGender === 'M' ? 'Male' : 'Female';
            document.getElementById('modalStudentCourse').textContent = studentCourse || 'Not specified';
            document.getElementById('modalStudentYear').textContent = studentYear || 'Not specified';
            
            // Check if student is assigned to personnel
            const assignedPersonnelInfo = document.getElementById('assignedPersonnelInfo');
            const unassignedInfo = document.getElementById('unassignedInfo');
            
            // This is a simplified check - in a real app, you'd fetch this data via AJAX
            // or pass it through data attributes
            const isAssigned = !button.closest('.col-md-4'); // If not in unassigned section
            
            if (isAssigned) {
                assignedPersonnelInfo.classList.remove('d-none');
                unassignedInfo.classList.add('d-none');
                
                // Get personnel info from the closest row
                const row = button.closest('tr');
                const personnelName = row.querySelector('td:first-child').textContent.trim();
                const personnelPosition = row.querySelector('td:nth-child(3)').textContent.trim();
                
                document.getElementById('modalPersonnelName').textContent = personnelName;
                document.getElementById('modalPersonnelPosition').textContent = personnelPosition;
                document.getElementById('modalAssignmentStatus').textContent = 'Assigned';
            } else {
                assignedPersonnelInfo.classList.add('d-none');
                unassignedInfo.classList.remove('d-none');
                document.getElementById('modalAssignmentStatus').textContent = 'Unassigned';
                
                // Set up the assign button in the modal
                const assignFromModalBtn = document.getElementById('assignFromModalBtn');
                assignFromModalBtn.addEventListener('click', function() {
                    // Close current modal
                    const currentModal = bootstrap.Modal.getInstance(studentDetailsModal);
                    currentModal.hide();
                    
                    // Open assign modal with pre-filled data
                    document.getElementById('studentId').value = studentId;
                    document.getElementById('studentName').textContent = studentName;
                    
                    // Show the assign modal
                    const assignModal = new bootstrap.Modal(document.getElementById('assignPersonnelModal'));
                    assignModal.show();
                });
            }
        });

        // Add click event to student badges for details modal
        const studentBadges = document.querySelectorAll('.student-badge');
        studentBadges.forEach(badge => {
            badge.addEventListener('click', function(e) {
                // Only trigger if not clicking on a button inside the badge
                if (!e.target.closest('button') && !e.target.closest('a')) {
                    // The modal will be triggered by data-bs-toggle and data-bs-target attributes
                }
            });
        });

        // Add animation when the reset button is clicked
        const resetButton = document.querySelector('[data-bs-target="#resetAssignmentsModal"]');
        if (resetButton) {
            resetButton.addEventListener('click', function() {
                this.classList.add('btn-pulse');
                setTimeout(() => {
                    this.classList.remove('btn-pulse');
                }, 500);
            });
        }
        
        // Add confirmation feedback when the form is submitted
        const resetForm = document.querySelector('#resetAssignmentsModal form');
        if (resetForm) {
            resetForm.addEventListener('submit', function() {
                const submitButton = this.querySelector('button[type="submit"]');
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resetting...';
                submitButton.disabled = true;
            });
        }
    });
</script>

<style>
    .btn-pulse {
        animation: pulse 0.5s;
    }
    
    @keyframes pulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.1);
        }
        100% {
            transform: scale(1);
        }
    }
</style>
{% endblock %} 