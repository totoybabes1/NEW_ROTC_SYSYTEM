{% extends 'admin/base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Assigned Personnel{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Content Column - Expanded to full width -->
        <div class="col-12 mb-4">

            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body p-5">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <div class="bg-primary bg-opacity-25 rounded-circle p-4">
                                        <i class="fa-solid fa-users text-primary fa-3x fw-bold"></i>
                                    </div>
                                </div>
                                <div class="col">
                                    <h1 class="display-4 mb-0 fw-bolder">Assigned Personnel</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

            <!-- Auto-Assign and Reset Buttons Card with Stats -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="accordion h-200" id="singleAccordion">
                        <div class="accordion-item">
                            <h1 class="accordion-header">
                                <button class="accordion-button fs-5 fw-semibold bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#accordionContent" aria-expanded="true" aria-controls="accordionContent">
                                    <i class="fas fa-cogs me-2"></i>Management & Statistics
                                </button>
                            </h1>
                            <div id="accordionContent" class="accordion-collapse collapse show" data-bs-parent="#singleAccordion">
                                <div class="accordion-body p-3">
                                    <div class="row g-3">
                                        <!-- Critical Message Alert -->
                                        <div class="col-12">
                                            <div class="alert alert-secondary mb-3 py-3">
                                                <h5 class="alert-heading mb-2">
                                                    <i class="fas fa-exclamation-circle me-2"></i>
                                                    Critical Message:
                                                </h5>
                                                <div class="fs-6">
                                                    Special cases require immediate attention and must be handled before regular assignments. 
                                                    These include students with specific requirements, medical conditions, or other exceptional circumstances.
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Action Buttons Grid -->
                                        <div class="col-12 col-lg-2">
                                            <div class="d-grid gap-2">
                                                <button type="button" 
                                                        class="btn btn-primary position-relative py-2"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#manualSpecialAssignmentModal">
                                                    <div class="d-flex align-items-center">
                                                        <div class="rounded-circle bg-white bg-opacity-25 p-1 me-2">
                                                            <i class="fas fa-user-plus text-white"></i>
                                                        </div>
                                                        <div class="text-start">
                                                            <small class="d-block text-white-50">Special</small>
                                                            <span class="fw-bold">Assignment</span>
                                                        </div>
                                                    </div>
                                                </button>

                                                <button class="btn btn-danger position-relative py-2" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#resetAssignmentsModal">
                                                    <div class="d-flex align-items-center">
                                                        <div class="rounded-circle bg-white bg-opacity-25 p-1 me-2">
                                                            <i class="fas fa-undo-alt text-white"></i>
                                                        </div>
                                                        <div class="text-start">
                                                            <small class="d-block text-white-50">Clear</small>
                                                            <span class="fw-bold">Reset All</span>
                                                        </div>
                                                    </div>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Assignment Limits Section -->
                                        <div class="col-12 col-lg-6">
                                            <div class="card h-100 border border-secondary shadow-sm">
                                                <div class="card-body p-3">
                                                    <h5 class="card-title mb-2">
                                                        <i class="fas fa-sliders-h me-2 text-primary"></i>
                                                        Student Limits
                                                    </h5>
                                                    <form action="{% url 'auto_assign_students' %}" method="post">
                                                        {% csrf_token %}
                                                        <div class="mb-3">
                                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                                <label for="maxLimitSlider" class="form-label mb-0">Maximum Students:</label>
                                                                <span id="maxLimitValue" class="badge bg-primary px-2 py-1">50</span>
                                                            </div>
                                                            <div class="position-relative">
                                                                <input type="range" class="form-range" id="maxLimitSlider" name="max_limit" 
                                                                    min="10" max="100" step="5" value="50"
                                                                    style="height: 1.2rem; background: linear-gradient(to right, #0d6efd 0%, #0d6efd 50%, #dee2e6 50%, #dee2e6 100%);">
                                                                <div class="position-absolute w-100" style="top: -8px;">
                                                                    <div class="d-flex justify-content-between">
                                                                        <div class="position-relative" style="width: 2px;">
                                                                            <div class="position-absolute" style="height: 10px; width: 2px; background-color: #0d6efd;"></div>
                                                                        </div>
                                                                        <div class="position-relative" style="width: 2px;">
                                                                            <div class="position-absolute" style="height: 10px; width: 2px; background-color: #0d6efd;"></div>
                                                                        </div>
                                                                        <div class="position-relative" style="width: 2px;">
                                                                            <div class="position-absolute" style="height: 10px; width: 2px; background-color: #0d6efd;"></div>
                                                                        </div>
                                                                        <div class="position-relative" style="width: 2px;">
                                                                            <div class="position-absolute" style="height: 10px; width: 2px; background-color: #0d6efd;"></div>
                                                                        </div>
                                                                        <div class="position-relative" style="width: 2px;">
                                                                            <div class="position-absolute" style="height: 10px; width: 2px; background-color: #0d6efd;"></div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="d-flex justify-content-between mt-2">
                                                                <span class="badge bg-primary px-2 py-1">10</span>
                                                                <span class="badge bg-primary px-2 py-1">25</span>
                                                                <span class="badge bg-primary px-2 py-1">50</span>
                                                                <span class="badge bg-primary px-2 py-1">75</span>
                                                                <span class="badge bg-primary px-2 py-1">100</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="alert alert-info mb-2 py-1">
                                                            <i class="fas fa-info-circle me-1"></i>
                                                            <small>Adjust based on personnel capacity</small>
                                                        </div>
                                                        <div class="text-center">
                                                            <button type="submit" class="btn btn-primary position-relative py-2">
                                                                <div class="d-flex align-items-center">
                                                                    <div class="rounded-circle bg-white bg-opacity-25 p-1 me-2">
                                                                        <i class="fas fa-magic text-white"></i>
                                                                    </div>
                                                                    <div class="text-start">
                                                                        <small class="d-block text-white-50">Apply</small>
                                                                        <span class="fw-bold">Auto Apply with Limits</span>
                                                                    </div>
                                                                </div>
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Statistics Section -->
                                        <div class="col-12 col-lg-4">
                                            <div class="card h-100 border-0 shadow-sm bg-primary bg-opacity-10">
                                                <div class="card-body p-3">
                                                    <div class="text-center">
                                                        <div class="rounded-circle bg-danger bg-opacity-10 p-3 mx-auto mb-2" style="width: fit-content;">
                                                            <i class="fas fa-user-times fa-2x text-danger"></i>
                                                        </div>
                                                        <div>
                                                            <h5 class="text-uppercase text-muted mb-2">Pending Assignments</h5>
                                                            <h1 class="fw-bold display-4">{{ unassigned_count }}</h1>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Section -->
            <div class="row mb-4">
                <div class="col-12">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-info alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>

            <!-- Nav Tabs -->
            <div class="card shadow-sm">
                <!-- Enhanced Tab Navigation -->
                <div class="card-header bg-white p-0 border-bottom">
                    <ul class="nav nav-tabs nav-fill border-0" id="assignmentTabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active py-3 px-4" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                        <i class="fas fa-chart-pie text-primary fa-lg"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fs-4">Overview</h6>
                                        <small class="text-muted fs-6">Assignment statistics</small>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link py-3 px-4" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments" type="button" role="tab">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                        <i class="fas fa-tasks text-primary fa-lg"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fs-4">Current Assignments</h6>
                                        <small class="text-muted fs-6">Active assignments</small>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link py-3 px-4" id="all-assignments-tab" data-bs-toggle="tab" data-bs-target="#all-assignments" type="button" role="tab">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                        <i class="fas fa-list-alt text-primary fa-lg"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fs-4">All Assigned Students</h6>
                                        <small class="text-muted fs-6">Complete assignment list</small>
                                    </div>
                                </div>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link py-3 px-4" id="unassigned-tab" data-bs-toggle="tab" data-bs-target="#unassigned" type="button" role="tab">
                                <div class="d-flex align-items-center justify-content-center">
                                    <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-2">
                                        <i class="fas fa-user-slash text-primary fa-lg"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0 fs-4">Unassigned Students</h6>
                                        <small class="text-muted fs-6">Pending assignments</small>
                                    </div>
                                </div>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Add this CSS to match the styles -->
            <style>
                #assignmentTabs .nav-link {
                    border: none;
                    position: relative;
                    transition: all 0.3s ease;
                }

                #assignmentTabs .nav-link:hover {
                    background-color: rgba(13, 110, 253, 0.05);
                }

                #assignmentTabs .nav-link.active {
                    border: none;
                    background-color: transparent;
                }

                #assignmentTabs .nav-link.active::after {
                    content: '';
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    width: 100%;
                    height: 3px;
                    background-color: #0d6efd;
                    border-radius: 3px 3px 0 0;
                }

                #assignmentTabs .nav-link:not(.active) {
                    color: #6c757d;
                }

                @media (max-width: 768px) {
                    #assignmentTabs .nav-link {
                        padding: 1rem 0.5rem;
                    }
                    
                    #assignmentTabs small {
                        display: none;
                    }
                }
            </style>

            <!-- Tab Content -->
            <div class="tab-content" id="assignmentTabsContent">
                <!-- Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
                    <!-- Assignment Distribution Graph -->
                    <div class="card mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-chart-bar me-2"></i>Assignment Distribution
                            </h6>
                        </div>
                        <div class="card-body">
                            <div style="height: 300px;">
                                <canvas id="assignmentDistributionChart"></canvas>
                            </div>
                            <div class="mt-3 d-flex justify-content-center">
                                <div class="d-flex align-items-center me-4">
                                    <div class="bg-primary rounded-circle me-2" style="width: 15px; height: 15px; opacity: 0.7;"></div>
                                    <span>Male Students</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="bg-danger rounded-circle me-2" style="width: 15px; height: 15px; opacity: 0.7;"></div>
                                    <span>Female Students</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assignments Tab -->
                <div class="tab-pane fade" id="assignments" role="tabpanel" aria-labelledby="assignments-tab">
                    <!-- Personnel Table -->
                    <div class="card mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-user-tie me-2"></i>Personnel Assignments
                            </h6>
                            <div class="d-flex align-items-center gap-3">
                                <!-- Personnel Selection Dropdown -->
                                <div class="input-group shadow-sm" style="width: 250px;">
                                    <span class="input-group-text bg-primary text-white border-0" style="font-size: 1.1rem;">
                                        <i class="fas fa-user-check"></i>
                                    </span>
                                    <select id="personnelFilterSelect" class="form-select border-0" style="font-size: 1.1rem; padding: 0.75rem 1rem;">
                                        <option value="">All Personnel</option>
                                        {% for personnel in personnel_list %}
                                            <option value="{{ personnel.id }}">{{ personnel.first_name }} {{ personnel.last_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <!-- Search Input -->
                                <div class="input-group shadow-sm" style="width: 450px;">
                                    <span class="input-group-text bg-primary text-white border-0" style="font-size: 1.1rem;">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" 
                                           id="personnelSearchInput" 
                                           class="form-control border-0" 
                                           placeholder="Search personnel by name or ID..."
                                           style="font-size: 1.1rem; padding: 0.75rem 1rem;">
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="personnelTable" width="100%" cellspacing="0">
                                    <tbody>
                                        {% for personnel in personnel_list %}
                                        <tr class="personnel-row" data-personnel-id="{{ personnel.id }}">
                                            <td>
                                                <div class="d-flex">
                                                    <!-- Personnel Info Column -->
                                                    <div class="me-4 shadow-sm rounded p-4 bg-white border" style="min-width: 300px;">
                                                        <!-- Profile Picture/Initials -->
                                                        <div class="d-flex align-items-center mb-4">
                                                            {% if personnel.profile_picture and personnel.profile_picture.url %}
                                                                <img src="{{ personnel.profile_picture.url }}" alt="Profile" class="rounded-circle me-3 shadow" width="80" height="80">
                                                            {% else %}
                                                                <div class="rounded-circle bg-gradient text-white d-flex align-items-center justify-content-center me-3 shadow" style="width: 80px; height: 80px; font-size: 1.8rem; background: linear-gradient(45deg, #4e73df, #224abe);">
                                                                        {{ personnel.first_name|first }}{{ personnel.last_name|first }}
                                                                </div>
                                                            {% endif %}
                                                            <div>
                                                                <h5 class="mb-2 fw-bold text-dark">{{ personnel.first_name }} {{ personnel.last_name }}</h5>
                                                                <span class="badge bg-primary bg-gradient px-3 py-2">{{ personnel.position }}</span>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Personnel Details -->
                                                        <div class="ms-2 bg-light rounded p-3">
                                                            <p class="mb-3 d-flex align-items-center">
                                                                <span class="bg-primary bg-opacity-10 p-2 rounded me-3">
                                                                    <i class="fas fa-id-card text-primary"></i>
                                                                </span>
                                                                <span>
                                                                    <strong class="d-block text-dark">Student ID</strong>
                                                                    <span class="text-muted">{{ personnel.student_id }}</span>
                                                                </span>
                                                            </p>
                                                            <p class="mb-3 d-flex align-items-center">
                                                                <span class="bg-primary bg-opacity-10 p-2 rounded me-3">
                                                                    <i class="fas fa-users text-primary"></i>
                                                                </span>
                                                                <span>
                                                                    <strong class="d-block text-dark">Flight Group</strong>
                                                                    <span class="text-muted">{{ personnel.flight_group.name|default:"Not Assigned" }}</span>
                                                                </span>
                                                            </p>
                                                            <p class="mb-3 d-flex align-items-center">
                                                                <span class="bg-primary bg-opacity-10 p-2 rounded me-3">
                                                                    <i class="fas fa-venus-mars text-primary"></i>
                                                                </span>
                                                                <span>
                                                                    <strong class="d-block text-dark">Gender</strong>
                                                                    {% if personnel.gender == 'Male' %}
                                                                        <span class="badge bg-primary bg-gradient">Male</span>
                                                                    {% else %}
                                                                        <span class="badge bg-danger bg-gradient">Female</span>
                                                                    {% endif %}
                                                                    {% if personnel.gender_assignment %}
                                                                        <span class="badge bg-info bg-gradient ms-1">Assigned: {{ personnel.gender_assignment }}</span>
                                                                    {% endif %}
                                                                </span>
                                                            </p>
                                                            <p class="mb-3 d-flex align-items-center">
                                                                <span class="bg-primary bg-opacity-10 p-2 rounded me-3">
                                                                    <i class="fas fa-phone text-primary"></i>
                                                                </span>
                                                                <span>
                                                                    <strong class="d-block text-dark">Contact</strong>
                                                                    <span class="text-muted">{{ personnel.phone_number }}</span>
                                                                </span>
                                                            </p>
                                                            <p class="mb-0 d-flex align-items-center">
                                                                <span class="bg-primary bg-opacity-10 p-2 rounded me-3">
                                                                    <i class="fas fa-calendar text-primary"></i>
                                                                </span>
                                                                <span>
                                                                    <strong class="d-block text-dark">Date Joined</strong>
                                                                    <span class="text-muted">{{ personnel.date_joined|date:"M d, Y" }}</span>
                                                                </span>
                                                            </p>
                                                        </div>
                                                    </div>

                                                    <!-- Assigned Students Column -->
                                                    <div class="flex-grow-1">
                                                        {% with assigned_students=personnel_assignments|get_item:personnel.id %}
                                                            {% if assigned_students %}
                                                                <div class="mb-2">
                                                                    {% for student in assigned_students %}
                                                                        <div class="border rounded p-2 mb-1 d-flex justify-content-between align-items-center">
                                                                            <div>
                                                                                <span class="small text-muted">{{ student.student_no }}</span>
                                                                                <span class="ms-2">{{ student.name }}</span>
                                                                            </div>
                                                                            <div>
                                                                                <button type="button" class="btn btn-outline-info me-1 new-reassign-btn"
                                                                                        data-bs-toggle="modal"
                                                                                        data-bs-target="#newReassignModal"
                                                                                        data-student-id="{{ student.id }}"
                                                                                        data-student-name="{{ student.name }}"
                                                                                        data-student-details="{{ student.student_no }}"
                                                                                        data-student-gender="{{ student.gender }}"
                                                                                        data-current-personnel-id="{{ personnel.id }}"
                                                                                        data-current-personnel-name="{{ personnel.first_name }} {{ personnel.last_name }}"
                                                                                        data-current-personnel-position="{{ personnel.position }}"
                                                                                        style="min-width: 120px;">
                                                                                    <i class="fas fa-exchange-alt me-2"></i>
                                                                                    Reassign
                                                                                </button>
                                                                                {% with assignment=student.personnelstudentassignment_set.first %}
                                                                                    {% if assignment %}
                                                                                        <a href="{% url 'remove_student_assignment' assignment_id=assignment.id %}" 
                                                                                           class="btn btn-outline-danger" 
                                                                                           style="min-width: 120px;"
                                                                                           onclick="return confirm('Are you sure you want to remove this assignment?')">
                                                                                            <i class="fas fa-times me-2"></i>
                                                                                            Remove
                                                                                        </a>
                                                                                    {% endif %}
                                                                                {% endwith %}
                                                                            </div>
                                                                        </div>
                                                                    {% endfor %}
                                                                </div>
                                                                <div>
                                                                    <span class="badge bg-primary">Total: {{ assigned_students|length }}</span>
                                                                    <span class="badge bg-info">Male: {{ assigned_students|filter_by_gender:'M'|length }}</span>
                                                                    <span class="badge bg-danger">Female: {{ assigned_students|filter_by_gender:'F'|length }}</span>
                                                                </div>
                                                            {% else %}
                                                                <div class="text-center text-muted py-2">
                                                                    <i class="fas fa-user-slash me-2"></i>
                                                                    <span>No students assigned</span>
                                                                </div>
                                                            {% endif %}
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                
                                <!-- Pagination -->
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div class="small text-muted">
                                        Showing <span id="personnelStartRecord">1</span> to <span id="personnelEndRecord">10</span> of <span id="personnelTotalRecords">{{ personnel_list|length }}</span> entries
                                    </div>
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination pagination-sm">
                                            <li class="page-item" id="personnelPrevPage">
                                                <a class="page-link" href="#" aria-label="Previous">
                                                    <span aria-hidden="true">&laquo;</span>
                                                </a>
                                            </li>
                                            <div id="personnelPageNumbers" class="d-flex">
                                                <!-- Page numbers will be inserted here by JavaScript -->
                                            </div>
                                            <li class="page-item" id="personnelNextPage">
                                                <a class="page-link" href="#" aria-label="Next">
                                                    <span aria-hidden="true">&raquo;</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- All Assignments Tab -->
                <div class="tab-pane fade" id="all-assignments" role="tabpanel" aria-labelledby="all-assignments-tab">
                    <!-- All Assigned Students Table -->
                    <div class="card mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-user-graduate me-2"></i>All Assigned Students
                            </h6>
                            <div class="input-group shadow-sm" style="width: 450px;">
                                <span class="input-group-text bg-primary text-white border-0" style="font-size: 1.1rem;">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       id="studentAssignmentSearchInput" 
                                       class="form-control border-0" 
                                       placeholder="Search by student name or student ID..."
                                       style="font-size: 1.1rem; padding: 0.75rem 1rem;">
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="studentAssignmentTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr class="align-middle">
                                            <th class="py-3">Student</th>
                                            <th class="py-3">Course/Year</th>
                                            <th class="py-3">Assigned To</th>
                                            <th class="py-3">Assignment Date</th>
                                            <th class="py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for assignment in all_assignments %}
                                        <tr class="student-assignment-row">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                                        {{ assignment.student.name|first }}
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold">{{ assignment.student.name }}</div>
                                                        <div class="small text-muted">{{ assignment.student.student_no }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ assignment.student.course }} ({{ assignment.student.year }})</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if assignment.personnel.profile_picture and assignment.personnel.profile_picture.url %}
                                                        <img src="{{ assignment.personnel.profile_picture.url }}" alt="Profile" class="rounded-circle me-2" width="32" height="32">
                                                    {% else %}
                                                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                                            {{ assignment.personnel.first_name|first }}{{ assignment.personnel.last_name|first }}
                                                        </div>
                                                    {% endif %}
                                                    <div>
                                                        <div class="fw-bold">{{ assignment.personnel.first_name }} {{ assignment.personnel.last_name }}</div>
                                                        <div class="small text-muted">{{ assignment.personnel.position }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="small">
                                                    <i class="far fa-calendar-alt me-1"></i>
                                                    {{ assignment.assigned_date|date:"M d, Y" }}
                                                </div>
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-info mb-1 new-reassign-btn"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#newReassignModal"
                                                        data-student-id="{{ assignment.student.id }}"
                                                        data-student-name="{{ assignment.student.name }}"
                                                        data-student-details="{{ assignment.student.student_no }}"
                                                        data-student-gender="{{ assignment.student.gender }}"
                                                        data-current-personnel-id="{{ assignment.personnel.id }}"
                                                        data-current-personnel-name="{{ assignment.personnel.first_name }} {{ assignment.personnel.last_name }}"
                                                        data-current-personnel-position="{{ assignment.personnel.position }}">
                                                    <i class="fas fa-exchange-alt me-1"></i> Reassign
                                                </button>
                                                <a href="{% url 'remove_student_assignment' assignment_id=assignment.id %}" 
                                                   class="btn btn-sm btn-outline-danger" 
                                                   onclick="return confirm('Are you sure you want to remove this assignment?')">
                                                    <i class="fas fa-unlink me-1"></i> Remove
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                                
                                <!-- Pagination for Student Assignment Table -->
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div class="small text-muted">
                                        Showing <span id="studentAssignmentStartRecord">1</span> to <span id="studentAssignmentEndRecord">10</span> of <span id="studentAssignmentTotalRecords">{{ all_assignments|length }}</span> entries
                                    </div>
                                    <nav aria-label="Page navigation">
                                        <ul class="pagination pagination-sm">
                                            <li class="page-item" id="studentAssignmentPrevPage">
                                                <a class="page-link" href="#" aria-label="Previous">
                                                    <span aria-hidden="true">&laquo;</span>
                                                </a>
                                            </li>
                                            <div id="studentAssignmentPageNumbers" class="d-flex">
                                                <!-- Page numbers will be inserted here by JavaScript -->
                                            </div>
                                            <li class="page-item" id="studentAssignmentNextPage">
                                                <a class="page-link" href="#" aria-label="Next">
                                                    <span aria-hidden="true">&raquo;</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Unassigned Tab -->
                <div class="tab-pane fade" id="unassigned" role="tabpanel" aria-labelledby="unassigned-tab">
                    <div class="card mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-user-slash me-2"></i>Unassigned Students
                                <span class="badge bg-primary ms-2">{{ unassigned_count }}</span>
                                <small class="text-muted ms-2">(Active Semesters Only)</small>
                            </h6>
                            <div class="input-group shadow-sm" style="width: 450px;">
                                <span class="input-group-text bg-primary text-white border-0" style="font-size: 1.1rem;">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       id="unassignedSearchInput" 
                                       class="form-control border-0" 
                                       placeholder="Search by name or student ID..."
                                       style="font-size: 1.1rem; padding: 0.75rem 1rem;">
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="unassignedTable">
                                    <thead>
                                        <tr class="align-middle">
                                            <th class="py-3">Student ID</th>
                                            <th class="py-3">Name</th>
                                            <th class="py-3">Gender</th>
                                            <th class="py-3">Course</th>
                                            <th class="py-3">Year</th>
                                            <th class="py-3">Status</th>
                                            <th class="py-3">Upload Date</th>
                                            <th class="py-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for student in unassigned_students %}
                                        <tr>
                                            <td>{{ student.student_no }}</td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                                                        {{ student.name|first }}
                                                    </div>
                                                    <div>
                                                        <div class="fw-bold">{{ student.name }}</div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if student.gender == 'M' %}
                                                    <span class="badge bg-primary">Male</span>
                                                {% else %}
                                                    <span class="badge bg-danger">Female</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ student.course }}</td>
                                            <td>
                                                <span class="badge bg-info">{{ student.year }} Year</span>
                                            </td>
                                            <td>
                                                {% if student.status == 'ACTIVE' %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-warning">Inactive</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ student.upload_date|date:"M d, Y" }}</td>
                                            <td>
                                                <div class="btn-group">
                                                    <button type="button" 
                                                            class="btn btn-outline-primary unassigned-assign-btn"
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#unassignedAssignModal"
                                                            data-student-id="{{ student.id }}"
                                                            data-student-name="{{ student.name }}"
                                                            data-student-gender="{{ student.gender }}"
                                                            data-student-course="{{ student.course }}"
                                                            data-student-year="{{ student.year }}"
                                                            style="padding: 8px 16px;">
                                                        <i class="fas fa-user-plus me-2"></i>Assign
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="9" class="text-center py-4">
                                                <div class="text-muted">
                                                    <i class="fas fa-info-circle me-2"></i>No unassigned students found
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>

                                <!-- Pagination for Unassigned Students -->
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div class="small text-muted">
                                        Showing <span id="unassignedStartRecord">1</span> to 
                                        <span id="unassignedEndRecord">10</span> of 
                                        <span id="unassignedTotalRecords">{{ unassigned_students|length }}</span> entries
                                    </div>
                                    <nav aria-label="Unassigned students pagination">
                                        <ul class="pagination pagination-sm" id="unassignedPagination">
                                            <li class="page-item" id="unassignedPrevPage">
                                                <a class="page-link" href="#" aria-label="Previous">
                                                    <span aria-hidden="true">&laquo;</span>
                                                </a>
                                            </li>
                                            <div id="unassignedPageNumbers" class="d-flex">
                                                <!-- Page numbers will be inserted here by JavaScript -->
                                            </div>
                                            <li class="page-item" id="unassignedNextPage">
                                                <a class="page-link" href="#" aria-label="Next">
                                                    <span aria-hidden="true">&raquo;</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Assign Modal -->
    <div class="modal fade" id="autoAssignModal" tabindex="-1" aria-labelledby="autoAssignModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="autoAssignModalLabel">
                        <i class="fas fa-magic me-2"></i>Auto-Assign Students
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'auto_assign_students' %}" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This will automatically assign unassigned students from <strong>active semesters only</strong> to personnel based on gender matching.
                        </div>
                        <p class="mb-0">Currently <strong>{{ unassigned_count }}</strong> unassigned students.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-magic me-1"></i> Auto-Assign
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assign Student Modal -->
    <div class="modal fade" id="assignStudentModal" tabindex="-1" aria-labelledby="assignStudentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignStudentModalLabel">Assign Student to Personnel</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'manual_assign_student' %}" method="post" id="assignStudentForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <!-- Hidden input for personnel ID -->
                        <input type="hidden" id="personnelId" name="personnel_id" required>
                        
                        <!-- Personnel Details Section -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Selected Personnel:</label>
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-3" 
                                     style="width: 48px; height: 48px;" 
                                     id="personnelInitials">
                                </div>
                                <div>
                                    <div class="fw-bold fs-5" id="personnelNameDisplay"></div>
                                    <div class="text-muted small" id="personnelPositionDisplay"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Student Selection Section -->
                        <div class="mb-4">
                            <label for="studentSearchInput" class="form-label fw-bold">Search Students:</label>
                            <div class="input-group mb-3">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       class="form-control" 
                                       id="studentSearchInput" 
                                       placeholder="Search by name or ID...">
                            </div>
                            
                            <label for="studentSelect" class="form-label">Select Student:</label>
                            <select class="form-select" 
                                    id="studentSelect" 
                                    name="student_id" 
                                    size="8"
                                    required>
                                <option value="">-- Select a student --</option>
                                {% for student in unassigned_students %}
                                    <option value="{{ student.id }}" 
                                            data-student-no="{{ student.student_no }}"
                                            data-gender="{{ student.gender }}"
                                            data-course="{{ student.course }}"
                                            data-year="{{ student.year }}">
                                        {{ student.name }} ({{ student.student_no }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Student Details Section -->
                        <div id="selectedStudentDetails" class="border rounded p-3 bg-light" style="display: none;">
                            <h6 class="mb-3">Selected Student Details:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Student ID:</strong> <span id="detailStudentId"></span></p>
                                    <p class="mb-2"><strong>Name:</strong> <span id="detailName"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-2"><strong>Course:</strong> <span id="detailCourse"></span></p>
                                    <p class="mb-2"><strong>Gender:</strong> <span id="detailGender"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="assignStudentBtn">
                            <i class="fas fa-user-plus me-1"></i> Assign Student
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assign Personnel Modal -->
    <div class="modal fade" id="assignPersonnelModal" tabindex="-1" aria-labelledby="assignPersonnelModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignPersonnelModalLabel">Assign Personnel to Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'manual_assign_student' %}" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" id="modalStudentId" name="student_id">
                        
                        <div class="mb-3">
                            <label class="form-label">Student:</label>
                            <div class="form-control bg-light" id="modalStudentName" readonly></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="modalPersonnelSelect" class="form-label">Select Personnel:</label>
                            <select class="form-select" id="modalPersonnelSelect" name="personnel_id" required>
                                <option value="" selected disabled>-- Select personnel --</option>
                                {% for personnel in personnel_list %}
                                <option value="{{ personnel.id }}">
                                    {{ personnel.first_name }} {{ personnel.last_name }} ({{ personnel.gender }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus me-1"></i> Assign
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- New Reassign Modal -->
    <div class="modal fade" id="newReassignModal" tabindex="-1" aria-labelledby="newReassignModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newReassignModalLabel">Reassign Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'reassign_student' %}" method="post" id="newReassignForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" id="newReassignStudentId" name="student_id">
                        
                        <!-- Current Assignment Info -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Current Assignment:</label>
                            <div class="d-flex align-items-center p-3 bg-light rounded mb-3">
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" 
                                     style="width: 48px; height: 48px;" 
                                     id="currentPersonnelInitials">
                                </div>
                                <div>
                                    <div class="fw-bold" id="currentPersonnelDisplay"></div>
                                    <div class="small text-muted">Current Personnel</div>
                                </div>
                            </div>

                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-3" 
                                     style="width: 48px; height: 48px;" 
                                     id="reassignStudentInitials">
                                </div>
                                <div>
                                    <div class="fw-bold" id="reassignStudentDisplay"></div>
                                    <div class="small text-muted" id="reassignStudentDetails"></div>
                                </div>
                            </div>
                        </div>

                        <!-- New Personnel Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Search New Personnel:</label>
                            <div class="input-group mb-3">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       id="newReassignSearch" 
                                       class="form-control" 
                                       placeholder="Search personnel by name or position...">
                            </div>

                            <label for="newReassignSelect" class="form-label">Select New Personnel:</label>
                            <select class="form-select" 
                                    id="newReassignSelect" 
                                    name="new_personnel_id" 
                                    required>
                                <option value="" selected disabled>-- Select new personnel --</option>
                                {% for personnel in personnel_list %}
                                    <option value="{{ personnel.id }}"
                                            data-search-text="{{ personnel.first_name|lower }} {{ personnel.last_name|lower }} {{ personnel.position|lower }}"
                                            data-gender="{{ personnel.gender }}"
                                            data-name="{{ personnel.first_name }} {{ personnel.last_name }}"
                                            data-position="{{ personnel.position }}">
                                        {{ personnel.first_name }} {{ personnel.last_name }} ({{ personnel.position }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                     
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-exchange-alt me-1"></i> Reassign
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Reset Assignments Modal -->
    <div class="modal fade" id="resetAssignmentsModal" tabindex="-1" aria-labelledby="resetAssignmentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="resetAssignmentsModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Reset All Assignments
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'reset_all_assignments' %}" method="POST">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Warning:</strong> This will remove all student assignments from <strong>active semesters only</strong>. This action cannot be undone.
                        </div>
                        <p>Are you sure you want to reset all student assignments?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash-alt me-2"></i>Reset All Assignments
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Bulk Delete Confirmation Modal -->
    <div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="bulkDeleteModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Remove Special Cases
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Warning:</strong> This action will remove the special case status for the selected students.
                    </div>
                    <p>Are you sure you want to remove the special case status for the following students?</p>
                    <ul id="selectedCasesList" class="list-group mt-3">
                        <!-- Selected cases will be listed here -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <form id="bulkDeleteForm" action="{% url 'bulk_remove_special_cases' %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="case_ids" id="caseIdsInput">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash-alt me-2"></i>Remove Selected Cases
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Modal for Unassigned Students Assignment -->
    <div class="modal fade" id="unassignedAssignModal" tabindex="-1" aria-labelledby="unassignedAssignModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="unassignedAssignModalLabel">Assign Personnel to Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'manual_assign_student' %}" method="post" id="unassignedAssignForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" id="unassignedStudentId" name="student_id">
                        
                        <!-- Student Details Section -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Student Information:</label>
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-3" 
                                     style="width: 48px; height: 48px;" 
                                     id="unassignedStudentInitials">
                                </div>
                                <div>
                                    <div class="fw-bold fs-5" id="unassignedStudentName"></div>
                                    <div class="text-muted small" id="unassignedStudentDetails"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Personnel Selection Section -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Search Personnel:</label>
                            <div class="input-group mb-3">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       id="unassignedPersonnelSearch" 
                                       class="form-control" 
                                       placeholder="Search personnel by name or position...">
                            </div>
                            
                            <label for="unassignedPersonnelSelect" class="form-label">Select Personnel:</label>
                            <select class="form-select" 
                                    id="unassignedPersonnelSelect" 
                                    name="personnel_id" 
                                    required>
                                <option value="" selected disabled>-- Select personnel --</option>
                                {% for personnel in personnel_list %}
                                    <option value="{{ personnel.id }}"
                                            data-search-text="{{ personnel.first_name|lower }} {{ personnel.last_name|lower }} {{ personnel.position|lower }}"
                                            data-gender="{{ personnel.gender }}"
                                            data-name="{{ personnel.first_name }} {{ personnel.last_name }}"
                                            data-position="{{ personnel.position }}">
                                        {{ personnel.first_name }} {{ personnel.last_name }} ({{ personnel.position }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Gender Match Warning -->
                        <div id="unassignedGenderMismatch" class="alert alert-warning d-none">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Warning: Personnel and student genders do not match
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus me-1"></i> Assign
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

   

    <!-- Keep only the Manual Special Assignment Modal -->
    <div class="modal fade" id="manualSpecialAssignmentModal" tabindex="-1" aria-labelledby="manualSpecialAssignmentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manualSpecialAssignmentModalLabel">
                        <i class="fas fa-user-tag me-2"></i>Special Case Assignment
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form action="{% url 'manual_special_case_assignment' %}" method="post">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Manage students with special assignments (band members, office workers) or gender preferences.
                            These students will be excluded from automatic assignment.
                        </div>

                        <!-- Student Selection with Search -->
                        <div class="mb-3">
                            <label class="form-label">Select Students</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text bg-primary text-white">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       id="studentSearchInput" 
                                       class="form-control" 
                                       placeholder="Search students...">
                            </div>
                            <select name="student_ids[]" 
                                    class="form-select" 
                                    id="multiStudentSelect" 
                                    multiple 
                                    size="8"
                                    required>
                                {% for student in unassigned_students %}
                                    <option value="{{ student.id }}" 
                                            data-gender="{{ student.gender }}"
                                            data-course="{{ student.course }}"
                                            data-search-text="{{ student.name|lower }} {{ student.student_no|lower }}">
                                        {{ student.name }} ({{ student.student_no }})
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">
                                Hold Ctrl (Windows) or Command (Mac) to select multiple students
                            </div>
                            <div class="mt-2">
                                <span class="badge bg-primary" id="selectedCount">0 students selected</span>
                            </div>
                        </div>

                        <!-- Personnel Selection -->
                        <div class="mb-3">
                            <label class="form-label">Assign to Personnel</label>
                            <select name="personnel_id" class="form-select" required>
                                <option value="">Choose personnel...</option>
                                {% for personnel in personnel_list %}
                                    <option value="{{ personnel.id }}">
                                        {{ personnel.first_name }} {{ personnel.last_name }} ({{ personnel.position }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Case Type -->
                        <div class="mb-3">
                            <label class="form-label">Special Case Type</label>
                            <select name="case_type" class="form-select" required>
                                <option value="band">Band Member</option>
                                <option value="office">Office Worker</option>
                                <option value="other_gender">Other Gender Preference</option>
                            </select>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label class="form-label">Notes (Optional)</label>
                            <textarea name="notes" class="form-control" rows="3" placeholder="Add any relevant notes..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus me-2"></i>Create Special Case Assignment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

   
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Utility function for pagination
    function setupPagination(tableId, searchInputId, itemsPerPage = 10) {
        const table = document.getElementById(tableId);
        const searchInput = document.getElementById(searchInputId);
        const tbody = table.querySelector('tbody');
        const rows = tbody.getElementsByTagName('tr');
        let currentPage = 1;
        
        // Get pagination elements based on table ID
        const prefix = tableId.replace('Table', '');
        const startRecord = document.getElementById(`${prefix}StartRecord`);
        const endRecord = document.getElementById(`${prefix}EndRecord`);
        const totalRecords = document.getElementById(`${prefix}TotalRecords`);
        const prevPageBtn = document.getElementById(`${prefix}PrevPage`);
        const nextPageBtn = document.getElementById(`${prefix}NextPage`);
        const pageNumbers = document.getElementById(`${prefix}PageNumbers`);
        
        function showPage(page) {
            const visibleRows = Array.from(rows).filter(row => !row.classList.contains('d-none'));
            const totalVisible = visibleRows.length;
            const totalPages = Math.ceil(totalVisible / itemsPerPage);
            
            // Ensure current page is valid
            if (page < 1) page = 1;
            if (page > totalPages && totalPages > 0) page = totalPages;
            currentPage = page;
            
            const start = (page - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            
            // Hide all rows first
            Array.from(rows).forEach(row => {
                row.style.display = 'none';
            });
            
            // Show only rows for current page
            visibleRows.slice(start, end).forEach(row => {
                row.style.display = '';
            });
            
            // Update pagination info
            if (startRecord) startRecord.textContent = totalVisible ? start + 1 : 0;
            if (endRecord) endRecord.textContent = Math.min(end, totalVisible);
            if (totalRecords) totalRecords.textContent = totalVisible;
            
            // Update pagination buttons
            updatePaginationButtons(page, totalPages);
        }
        
        function updatePaginationButtons(currentPage, totalPages) {
            if (prevPageBtn) {
                prevPageBtn.classList.toggle('disabled', currentPage <= 1);
                prevPageBtn.setAttribute('aria-disabled', currentPage <= 1);
            }
            
            if (nextPageBtn) {
                nextPageBtn.classList.toggle('disabled', currentPage >= totalPages || totalPages === 0);
                nextPageBtn.setAttribute('aria-disabled', currentPage >= totalPages || totalPages === 0);
            }
            
            if (pageNumbers) {
                pageNumbers.innerHTML = '';
                
                // Determine which page numbers to show
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                
                // Adjust if we're near the end
                if (endPage - startPage < 4 && startPage > 1) {
                    startPage = Math.max(1, endPage - 4);
                }
                
                // Add first page and ellipsis if needed
                if (startPage > 1) {
                    addPageButton(1);
                    if (startPage > 2) {
                        const ellipsis = document.createElement('li');
                        ellipsis.className = 'page-item disabled';
                        ellipsis.innerHTML = '<span class="page-link">...</span>';
                        pageNumbers.appendChild(ellipsis);
                    }
                }
                
                // Add page numbers
                for (let i = startPage; i <= endPage; i++) {
                    addPageButton(i);
                }
                
                // Add last page and ellipsis if needed
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const ellipsis = document.createElement('li');
                        ellipsis.className = 'page-item disabled';
                        ellipsis.innerHTML = '<span class="page-link">...</span>';
                        pageNumbers.appendChild(ellipsis);
                    }
                    addPageButton(totalPages);
                }
            }
            
            function addPageButton(pageNum) {
                const li = document.createElement('li');
                li.className = `page-item ${pageNum === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#">${pageNum}</a>`;
                li.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage(pageNum);
                });
                pageNumbers.appendChild(li);
            }
        }
        
        function filterTable(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            Array.from(rows).forEach(row => {
                const text = row.textContent.toLowerCase();
                row.classList.toggle('d-none', searchTerm && !text.includes(searchTerm));
            });
            currentPage = 1;
            showPage(currentPage);
        }
        
        // Event Listeners
        if (searchInput) {
            searchInput.addEventListener('input', (e) => filterTable(e.target.value));
        }
        
        if (prevPageBtn) {
            prevPageBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (currentPage > 1) {
                    showPage(currentPage - 1);
                }
            });
        }
        
        if (nextPageBtn) {
            nextPageBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const visibleRows = Array.from(rows).filter(row => !row.classList.contains('d-none'));
                const totalPages = Math.ceil(visibleRows.length / itemsPerPage);
                if (currentPage < totalPages) {
                    showPage(currentPage + 1);
                }
            });
        }
        
        // Initial setup
        showPage(1);
        
        // Return methods for external use
        return {
            showPage,
            filterTable
        };
    }
    
    // Setup pagination for all tables
    setupPagination('personnelTable', 'personnelSearchInput');
    setupPagination('studentAssignmentTable', 'studentAssignmentSearchInput');
    setupPagination('unassignedTable', 'unassignedSearchInput');
    
    // Handle tab changes to refresh pagination
    const assignmentTabs = document.getElementById('assignmentTabs');
    if (assignmentTabs) {
        assignmentTabs.addEventListener('shown.bs.tab', function(event) {
            const targetId = event.target.getAttribute('data-bs-target');
            if (targetId === '#unassigned') {
                // Refresh unassigned students pagination
                setupPagination('unassignedTable', 'unassignedSearchInput');
            } else if (targetId === '#assignments') {
                // Refresh personnel pagination
                setupPagination('personnelTable', 'personnelSearchInput');
            } else if (targetId === '#all-assignments') {
                // Refresh all assignments pagination
                setupPagination('studentAssignmentTable', 'studentAssignmentSearchInput');
            }
        });
    }
    
    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Initialize variables for Unassigned Students Assignment Modal
    const unassignedModal = document.getElementById('unassignedAssignModal');
    const unassignedStudentId = document.getElementById('unassignedStudentId');
    const unassignedStudentName = document.getElementById('unassignedStudentName');
    const unassignedStudentDetails = document.getElementById('unassignedStudentDetails');
    const unassignedStudentInitials = document.getElementById('unassignedStudentInitials');
    const unassignedPersonnelSearch = document.getElementById('unassignedPersonnelSearch');
    const unassignedPersonnelSelect = document.getElementById('unassignedPersonnelSelect');
    const unassignedGenderMismatch = document.getElementById('unassignedGenderMismatch');

    // Handle modal opening
    if (unassignedModal) {
        unassignedModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            
            // Get student data from button attributes
            const studentId = button.getAttribute('data-student-id');
            const studentName = button.getAttribute('data-student-name');
            const studentGender = button.getAttribute('data-student-gender');
            const studentCourse = button.getAttribute('data-student-course');
            const studentYear = button.getAttribute('data-student-year');

            // Update modal content
            unassignedStudentId.value = studentId;
            unassignedStudentName.textContent = studentName;
            unassignedStudentDetails.textContent = `${studentCourse} - ${studentYear} Year`;
            unassignedStudentInitials.textContent = studentName.split(' ').map(n => n[0]).join('');

            // Reset personnel selection
            unassignedPersonnelSelect.value = '';
            unassignedPersonnelSearch.value = '';
            unassignedGenderMismatch.classList.add('d-none');

            // Show all personnel options
            Array.from(unassignedPersonnelSelect.options).forEach(option => {
                option.style.display = '';
            });
        });
    }

    // Handle personnel search
    if (unassignedPersonnelSearch && unassignedPersonnelSelect) {
        unassignedPersonnelSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            Array.from(unassignedPersonnelSelect.options).forEach(option => {
                if (option.value === '') return; // Skip placeholder option
                
                const searchText = option.getAttribute('data-search-text') || '';
                const matchesSearch = searchText.includes(searchTerm);
                option.style.display = matchesSearch ? '' : 'none';
            });
        });
    }

    // Handle personnel selection and gender matching
    if (unassignedPersonnelSelect) {
        unassignedPersonnelSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value === '') return;

            const personnelGender = selectedOption.getAttribute('data-gender');
            const studentGender = document.querySelector(`button[data-student-id="${unassignedStudentId.value}"]`)
                                        .getAttribute('data-student-gender');

            // Show/hide gender mismatch warning
            if (personnelGender && studentGender) {
                const genderMatch = (personnelGender === 'Male' && studentGender === 'M') || 
                                  (personnelGender === 'Female' && studentGender === 'F');
                unassignedGenderMismatch.classList.toggle('d-none', genderMatch);
            }
        });
    }

    // Initialize variables for new reassign modal
    const newReassignModal = document.getElementById('newReassignModal');
    const newReassignStudentId = document.getElementById('newReassignStudentId');
    const currentPersonnelDisplay = document.getElementById('currentPersonnelDisplay');
    const currentPersonnelInitials = document.getElementById('currentPersonnelInitials');
    const reassignStudentDisplay = document.getElementById('reassignStudentDisplay');
    const reassignStudentDetails = document.getElementById('reassignStudentDetails');
    const reassignStudentInitials = document.getElementById('reassignStudentInitials');
    const newReassignSearch = document.getElementById('newReassignSearch');
    const newReassignSelect = document.getElementById('newReassignSelect');
    const newReassignGenderMismatch = document.getElementById('newReassignGenderMismatch');

    // Handle modal opening
    if (newReassignModal) {
        newReassignModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            
            // Get data from button attributes
            const studentId = button.getAttribute('data-student-id');
            const studentName = button.getAttribute('data-student-name');
            const studentDetails = button.getAttribute('data-student-details');
            const studentGender = button.getAttribute('data-student-gender');
            const currentPersonnelName = button.getAttribute('data-current-personnel-name');
            const currentPersonnelPosition = button.getAttribute('data-current-personnel-position');

            // Update modal content
            newReassignStudentId.value = studentId;
            currentPersonnelDisplay.textContent = `${currentPersonnelName} - ${currentPersonnelPosition}`;
            currentPersonnelInitials.textContent = currentPersonnelName.split(' ').map(n => n[0]).join('');
            reassignStudentDisplay.textContent = studentName;
            reassignStudentDetails.textContent = studentDetails;
            reassignStudentInitials.textContent = studentName.split(' ').map(n => n[0]).join('');

            // Reset personnel selection
            newReassignSelect.value = '';
            newReassignSearch.value = '';
            newReassignGenderMismatch.classList.add('d-none');

            // Show all personnel options
            Array.from(newReassignSelect.options).forEach(option => {
                option.style.display = '';
            });
        });
    }

    // Handle personnel search
    if (newReassignSearch && newReassignSelect) {
        newReassignSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            Array.from(newReassignSelect.options).forEach(option => {
                if (option.value === '') return; // Skip placeholder option
                
                const searchText = option.getAttribute('data-search-text') || '';
                const matchesSearch = searchText.includes(searchTerm);
                option.style.display = matchesSearch ? '' : 'none';
            });
        });
    }

    // Handle personnel selection and gender matching
    if (newReassignSelect) {
        newReassignSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value === '') return;

            const personnelGender = selectedOption.getAttribute('data-gender');
            const studentGender = document.querySelector(`button[data-student-id="${newReassignStudentId.value}"]`)
                                        .getAttribute('data-student-gender');

            // Show/hide gender mismatch warning
            if (personnelGender && studentGender) {
                const genderMatch = (personnelGender === 'Male' && studentGender === 'M') || 
                                  (personnelGender === 'Female' && studentGender === 'F');
                newReassignGenderMismatch.classList.toggle('d-none', genderMatch);
            }
        });
    }

    // Personnel filter functionality
    const personnelFilterSelect = document.getElementById('personnelFilterSelect');
    const personnelSearchInput = document.getElementById('personnelSearchInput');
    const personnelRows = document.querySelectorAll('.personnel-row');
    
    // Function to filter personnel based on both dropdown and search input
    function filterPersonnel() {
        const selectedPersonnelId = personnelFilterSelect.value;
        const searchText = personnelSearchInput.value.toLowerCase();
        
        personnelRows.forEach(row => {
            const personnelId = row.getAttribute('data-personnel-id');
            const personnelName = row.querySelector('h5.fw-bold').textContent.toLowerCase();
            const personnelPosition = row.querySelector('.badge.bg-primary').textContent.toLowerCase();
            const personnelStudentId = row.querySelector('.text-muted:nth-of-type(1)').textContent.toLowerCase();
            
            const matchesDropdown = !selectedPersonnelId || personnelId === selectedPersonnelId;
            const matchesSearch = !searchText || 
                                 personnelName.includes(searchText) || 
                                 personnelPosition.includes(searchText) || 
                                 personnelStudentId.includes(searchText);
            
            if (matchesDropdown && matchesSearch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update pagination after filtering
        updatePersonnelPagination();
    }
    
    // Add event listeners
    if (personnelFilterSelect) {
        personnelFilterSelect.addEventListener('change', filterPersonnel);
    }
    
    if (personnelSearchInput) {
        personnelSearchInput.addEventListener('input', filterPersonnel);
    }
    
    // Add data-personnel-id attribute to each row for filtering
    personnelRows.forEach(row => {
        const personnelInfoDiv = row.querySelector('.me-4.shadow-sm');
        if (personnelInfoDiv) {
            const personnelNameElement = personnelInfoDiv.querySelector('h5.fw-bold');
            if (personnelNameElement) {
                const personnelName = personnelNameElement.textContent.trim();
                // Find the personnel ID from the list
                {% for personnel in personnel_list %}
                if (personnelName === "{{ personnel.first_name }} {{ personnel.last_name }}") {
                    row.setAttribute('data-personnel-id', "{{ personnel.id }}");
                }
                {% endfor %}
            }
        }
    });

    // Add Assignment Distribution Chart initialization
    const assignmentDistributionChart = document.getElementById('assignmentDistributionChart');
    if (assignmentDistributionChart) {
        // Get personnel data from the backend
        const personnelLabels = [
            {% for personnel in personnel_list %}
                "{{ personnel.first_name }} {{ personnel.last_name }}",
            {% endfor %}
        ];
        
        // Get assignment counts by gender
        const maleAssignments = [
            {% for personnel in personnel_list %}
                {% with assigned_students=personnel_assignments|get_item:personnel.id %}
                    {{ assigned_students|filter_by_gender:'M'|length }},
                {% endwith %}
            {% endfor %}
        ];
        
        const femaleAssignments = [
            {% for personnel in personnel_list %}
                {% with assigned_students=personnel_assignments|get_item:personnel.id %}
                    {{ assigned_students|filter_by_gender:'F'|length }},
                {% endwith %}
            {% endfor %}
        ];
        
        // Create the chart
        new Chart(assignmentDistributionChart, {
            type: 'bar',
            data: {
                labels: personnelLabels,
                datasets: [
                    {
                        label: 'Male Students',
                        data: maleAssignments,
                        backgroundColor: 'rgba(78, 115, 223, 0.7)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Female Students',
                        data: femaleAssignments,
                        backgroundColor: 'rgba(231, 74, 59, 0.7)',
                        borderColor: 'rgba(231, 74, 59, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                return tooltipItems[0].label;
                            },
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y || 0;
                                return `${label}: ${value} students`;
                            }
                        }
                    }
                }
            }
        });
    }

    // Add this function to your JavaScript code
    function updatePersonnelPagination() {
        // Get all visible rows
        const visibleRows = Array.from(document.querySelectorAll('.personnel-row'))
            .filter(row => row.style.display !== 'none');
        
        const totalVisible = visibleRows.length;
        const itemsPerPage = 10; // Adjust if needed
        const totalPages = Math.ceil(totalVisible / itemsPerPage);
        
        // Update pagination info
        document.getElementById('personnelTotalRecords').textContent = totalVisible;
        
        // Update page numbers
        const pageNumbers = document.getElementById('personnelPageNumbers');
        pageNumbers.innerHTML = '';
        
        for (let i = 1; i <= totalPages; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === 1 ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener('click', (e) => {
                e.preventDefault();
                showPersonnelPage(i);
            });
            pageNumbers.appendChild(li);
        }
        
        // Show first page
        showPersonnelPage(1);
    }

    function showPersonnelPage(page) {
        const itemsPerPage = 10; // Adjust if needed
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        
        // Get all visible rows
        const visibleRows = Array.from(document.querySelectorAll('.personnel-row'))
            .filter(row => row.style.display !== 'none');
        
        // Hide all rows first
        visibleRows.forEach(row => row.style.display = 'none');
        
        // Show only rows for current page
        visibleRows.slice(start, end).forEach(row => row.style.display = '');
        
        // Update pagination info
        document.getElementById('personnelStartRecord').textContent = visibleRows.length ? start + 1 : 0;
        document.getElementById('personnelEndRecord').textContent = Math.min(end, visibleRows.length);
        
        // Update active page button
        const pageButtons = document.querySelectorAll('#personnelPageNumbers .page-item');
        pageButtons.forEach((btn, i) => {
            btn.classList.toggle('active', i + 1 === page);
        });
        
        // Update prev/next buttons
        document.getElementById('personnelPrevPage').classList.toggle('disabled', page === 1);
        document.getElementById('personnelNextPage').classList.toggle('disabled', page === Math.ceil(visibleRows.length / itemsPerPage));
    }

    // Function to show a specific page of special cases
    function showSpecialCasesPage(page) {
        const table = document.getElementById('specialCasesTable');
        const tbody = table.querySelector('tbody');
        const rows = tbody.querySelectorAll('tr:not([style*="display: none"])');
        const itemsPerPage = 10;
        const start = (page - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        
        Array.from(rows).forEach((row, index) => {
            row.style.display = (index >= start && index < end) ? '' : 'none';
        });
        
        // Update active page button
        const pageButtons = document.querySelectorAll('#specialCasesPageNumbers .page-item');
        pageButtons.forEach((btn, idx) => {
            btn.classList.toggle('active', idx + 1 === page);
        });
        
        // Update pagination info
        const startRecord = document.getElementById('specialCasesStartRecord');
        const endRecord = document.getElementById('specialCasesEndRecord');
        
        if (startRecord && endRecord) {
            startRecord.textContent = rows.length > 0 ? start + 1 : 0;
            endRecord.textContent = Math.min(end, rows.length);
        }
        
        // Update prev/next buttons
        const prevPage = document.getElementById('specialCasesPrevPage');
        const nextPage = document.getElementById('specialCasesNextPage');
        
        if (prevPage) prevPage.classList.toggle('disabled', page === 1);
        if (nextPage) nextPage.classList.toggle('disabled', page >= Math.ceil(rows.length / itemsPerPage));
    }

    // Add data-handler-id attributes to handler cells for easier filtering
    document.addEventListener('DOMContentLoaded', function() {
        const specialCasesTable = document.getElementById('specialCasesTable');
        if (specialCasesTable) {
            const rows = specialCasesTable.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const handlerCell = row.querySelector('td:nth-child(5)');
                if (handlerCell) {
                    const handlerDiv = handlerCell.querySelector('.d-flex');
                    if (handlerDiv) {
                        // Extract handler ID from any existing data attributes or links
                        const handlerId = handlerDiv.getAttribute('data-handler-id') || '';
                        handlerDiv.setAttribute('data-handler-id', handlerId);
                    }
                }
            });
        }
    });

    // Max limit slider functionality
    const maxLimitSlider = document.getElementById('maxLimitSlider');
    const maxLimitValue = document.getElementById('maxLimitValue');
    
    if (maxLimitSlider && maxLimitValue) {
        maxLimitSlider.addEventListener('input', function() {
            maxLimitValue.textContent = this.value;
        });
    }

    // Get the elements
    const studentSearchInput = document.getElementById('studentSearchInput');
    const multiStudentSelect = document.getElementById('multiStudentSelect');
    const selectedCount = document.getElementById('selectedCount');

    // Function to update selected count
    function updateSelectedCount() {
        const count = multiStudentSelect.selectedOptions.length;
        selectedCount.textContent = `${count} student${count !== 1 ? 's' : ''} selected`;
    }

    // Add event listener for selection changes
    multiStudentSelect.addEventListener('change', updateSelectedCount);

    // Add event listener for search input
    studentSearchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        
        Array.from(multiStudentSelect.options).forEach(option => {
            const searchText = option.getAttribute('data-search-text');
            const matchesSearch = !searchTerm || searchText.includes(searchTerm);
            option.style.display = matchesSearch ? '' : 'none';
        });
    });

    // Initialize selected count
    updateSelectedCount();
});
</script>
{% endblock %} 